<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volta Electrica & Electronica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos CSS integrados */
        :root {
            --primary-color: #4a90e2; /* Azul vibrante */
            --secondary-color: #f0f4f8; /* Gris claro suave */
            --dark-nav-color: #2c3e50; /* Azul oscuro para la navegación */
            --text-color-light: #fff; /* Texto blanco */
            --text-color: #333; /* Texto oscuro general */
            --muted-text-color: #666; /* Texto gris más claro */
            --active-bg-color: #e6f0ff; /* Fondo activo suave */
            --shadow-color: rgba(0, 0, 0, 0.1); /* Sombra ligera */
            --dark-shadow-color: rgba(0, 0, 0, 0.3); /* Sombra más oscura */
            --gold-color: #d4af37; /* Color dorado para acentos */
            --button-3d-shadow: rgba(0, 0, 0, 0.2); /* Sombra 3D para botones */
            --modal-bg-color: rgba(0, 0, 0, 0.7); /* Fondo de modal semi-transparente */
            --input-focus-border: #80bdff; /* Borde de input al enfocar */
            --button-hover-bg: #3876c7; /* Fondo de botón al pasar el ratón */
            --pearl-color: #eceff1; /* Color perla para íconos inactivos */
        }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Alinea la app al fondo de la pantalla por defecto (móvil) */
            min-height: 100vh;
            background-color: var(--secondary-color);
        }
        /* Ajustes para tabletas y laptops */
        @media (min-width: 768px) {
            body {
                align-items: center; /* Centra la app verticalmente en pantallas grandes */
            }
            .app-container {
                max-width: 700px; /* Ancho máximo para pantallas más grandes */
                height: 90vh; /* Ocupa el 90% de la altura de la vista en pantallas grandes */
                border-radius: 15px; /* Bordes redondeados para una apariencia de aplicación de escritorio */
                margin: auto; /* Centra la aplicación en pantallas grandes */
            }
        }
        .app-container {
            width: 100%;
            max-width: 380px; /* Ancho máximo reducido para simular móvil por defecto */
            height: 100vh; /* Altura completa de la vista en móvil */
            display: flex;
            flex-direction: column;
            background-color: #fff;
            box-shadow: 0 0 25px var(--shadow-color);
            position: relative;
        }
        .content {
            flex-grow: 1; /* Permite que el contenido ocupe el espacio restante */
            overflow-y: auto; /* Habilita el scroll si el contenido es largo */
            padding: 12px; /* Padding reducido */
            padding-bottom: 60px; /* Espacio reducido para la barra de navegación inferior */
        }
        .tab-content {
            display: none; /* Oculta las pestañas por defecto */
            animation: fadeIn 0.4s ease-out; /* Animación de aparición */
        }
        .tab-content.active {
            display: block; /* Muestra la pestaña activa */
        }
        h2 {
            color: var(--primary-color);
            font-size: 1.4em; /* Tamaño de fuente reducido */
            margin-bottom: 10px; /* Margen reducido */
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
            display: inline-block; /* Ajusta el borde inferior al texto */
        }
        h4 {
            color: var(--primary-color);
            margin-top: 12px; /* Margen reducido */
            margin-bottom: 6px; /* Margen reducido */
        }
        p {
            color: var(--muted-text-color);
            line-height: 1.5; /* Altura de línea reducida */
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Espacio reducido entre botones */
            margin-top: 12px;
        }
        .action-button {
            display: flex;
            align-items: center;
            padding: 10px 12px; /* Padding reducido */
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            background-color: #fff;
            color: var(--primary-color);
            font-size: 0.9em; /* Tamaño de fuente reducido */
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease; /* Transición suave para hover */
        }
        .action-button:hover {
            background-color: var(--primary-color);
            color: #fff;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
            transform: translateY(-2px); /* Efecto de elevación */
        }
        .action-button .button-icon {
            font-size: 1.2em; /* Tamaño de ícono reducido */
            margin-right: 10px; /* Margen reducido */
        }
        /* Estilos de la barra de navegación inferior */
        .bottom-nav {
            display: flex;
            width: 100%;
            height: 50px; /* Altura disminuida */
            background-color: var(--dark-nav-color);
            border-top: 1px solid #34495e;
            box-shadow: 0 -5px 15px var(--dark-shadow-color);
            position: absolute;
            bottom: 0;
            z-index: 1000;
        }
        .nav-item {
            flex: 1; /* Distribuye los ítems equitativamente */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color-light);
            position: relative;
            padding: 2px; /* Padding reducido */
            margin: 0 1px;
        }
        .nav-item:not(.active) {
            opacity: 0.8; /* Menos opacidad para ítems inactivos */
        }
        .nav-item:not(.active) .icon { /* Estilo para el ícono inactivo */
            color: var(--pearl-color); /* Color perla para íconos inactivos */
        }
        .nav-item.active {
            color: var(--gold-color);
            font-weight: 600;
            opacity: 1;
            background-color: #34495e; /* Fondo ligeramente diferente para activo */
            border-radius: 8px 8px 0 0; /* Bordes redondeados superiores */
            border-bottom: 3px solid var(--button-3d-shadow); /* Sombra inferior reducida */
            transform: translateY(-3px); /* Efecto de elevación reducido */
            padding-bottom: 6px; /* Padding reducido */
        }
        .nav-item.active:hover {
            transform: translateY(0); /* Vuelve a la posición normal al pasar el ratón */
            border-bottom: 0; /* Quita la sombra inferior al pasar el ratón */
        }
        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 70%; /* Ancho reducido */
            height: 3px;
            background-color: var(--gold-color);
            transition: width 0.3s ease;
        }
        .nav-item:not(.active)::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0; /* Sin línea para inactivos */
            height: 3px;
            background-color: var(--gold-color);
            transition: width 0.3s ease;
        }
        .icon {
            font-size: 1.7em; /* Tamaño de ícono disminuido */
            line-height: 1;
            transition: transform 0.3s ease-in-out, color 0.3s ease;
        }
        .nav-item.active .icon {
            transform: scale(1.1); /* Icono ligeramente más grande al estar activo */
        }
        span {
            font-size: 0.7em; /* Tamaño de fuente reducido */
            font-weight: 500;
            white-space: nowrap;
            transition: opacity 0.3s ease;
            margin-top: 2px; /* Margen reducido */
        }
        .nav-item:not(.active) span {
            opacity: 0; /* Oculta el texto para inactivos */
            height: 0;
            overflow: hidden;
        }
        .nav-item.active span {
            color: var(--text-color-light);
            opacity: 1; /* Muestra el texto para activos */
        }
        /* Estilos para las ventanas modales */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Permite desplazamiento vertical y horizontal en el modal si el contenido lo excede */
            background-color: var(--modal-bg-color);
            padding-top: 60px;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 8px; /* Padding reducido para pantallas pequeñas */
            border-radius: 10px;
            width: 90%;
            max-width: 320px; /* Ancho máximo reducido para pantallas pequeñas */
            box-shadow: 0 10px 30px var(--dark-shadow-color);
            animation: slideIn 0.3s ease-out;
            padding-bottom: 15px;
            font-size: 0.85em; /* Tamaño de fuente reducido para ahorrar espacio */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px; /* Padding reducido */
            margin-bottom: 15px; /* Margen reducido */
        }
        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2em; /* Tamaño de fuente reducido */
        }
        .close-button {
            color: var(--muted-text-color);
            font-size: 20px; /* Tamaño de fuente reducido */
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover, .close-button:focus {
            color: var(--primary-color);
            text-decoration: none;
        }
        .modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-actions button {
            flex-grow: 1;
            padding: 8px; /* Padding reducido */
            border: none;
            border-radius: 8px;
            font-size: 0.85em; /* Tamaño de fuente reducido */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .modal-actions button.close-btn {
            background-color: #e0e0e0;
            color: var(--text-color);
        }
        .modal-actions button.close-btn:hover {
            background-color: #c9c9c9;
            transform: translateY(-2px);
        }
        /* Estilos específicos para el formulario de inicio de sesión (Pestaña Portal) */
        .login-card {
            background-color: #fff;
            padding: 20px; /* Padding reducido */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            animation: slideInUp 0.5s ease-out;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 12px; /* Espacio reducido entre elementos del formulario */
        }
        .login-form label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: 600;
            font-size: 0.95em;
        }
        .input-group {
            position: relative;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px; /* Padding reducido */
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 0.95em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
            outline: none;
        }
        /* Estilo para el placeholder del input */
        .input-group input::placeholder, .input-group textarea::placeholder {
            color: var(--muted-text-color); /* Color gris suave */
            opacity: 0.8; /* Ligeramente transparente para un efecto más sutil */
        }
        .input-group .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--muted-text-color);
            font-size: 1.1em;
            transition: color 0.3s ease;
        }
        .input-group .toggle-password:hover {
            color: var(--primary-color);
        }
        .login-form button, .admin-button {
            width: 100%;
            padding: 12px; /* Padding reducido */
            background-color: var(--primary-color);
            color: var(--text-color-light);
            border: none;
            border-radius: 8px;
            font-size: 1em; /* Tamaño de fuente reducido */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            margin-top: 10px;
        }
        .login-form button:hover, .admin-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
        }
        /* Estilo para la imagen en la sección de inicio */
        .hero-image {
            max-width: 100%;
            width: auto; /* Permitir que la imagen se ajuste automáticamente */
            height: auto;
            display: block; /* Para centrarla con margin auto */
            margin-left: auto;
            margin-right: auto;
            border-radius: 10px; /* Bordes redondeados para la imagen */
            margin-bottom: 20px; /* Espacio reducido debajo de la imagen */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Sombra suave para la imagen */
        }
        /* Estilos para botones de admin */
        .admin-button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        .admin-button {
            display: flex;
            align-items: center;
            padding: 10px 15px; /* Padding reducido */
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            background-color: #fff;
            color: var(--primary-color);
            font-size: 0.9em; /* Tamaño de fuente reducido */
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .admin-button .button-icon {
            font-size: 1.3em; /* Tamaño de ícono reducido */
            margin-right: 10px; /* Margen reducido */
        }
        .admin-button.logout-button {
            background-color: #f44336;
            color: #fff;
            border-color: #f44336;
        }
        .admin-button.logout-button:hover {
            background-color: #d32f2f;
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }
        /* Estilos para tablas de contenido */
        .table-responsive {
            overflow-x: auto; /* Permite el desplazamiento horizontal */
            margin-top: 20px; /* Espacio para separar de elementos anteriores */
            border-radius: 8px; /* Bordes redondeados para el contenedor de la tabla */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Sombra ligera */
        }
        .content-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em; /* Tamaño de fuente reducido */
            min-width: 400px; /* Asegura que la tabla tenga un ancho mínimo para activar el scroll si es necesario */
        }
        .content-table th, .content-table td {
            border: 1px solid #ddd;
            padding: 5px; /* Padding reducido */
            text-align: left;
            word-wrap: break-word; /* Asegura que las palabras largas se rompan */
            white-space: normal; /* Permite el salto de línea normal */
        }
        .content-table th {
            background-color: var(--primary-color);
            color: white;
        }
        .content-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .content-table tr:hover {
            background-color: #ddd;
        }
        .content-table .actions-column {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .content-table .actions-column button {
            padding: 4px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            border: none;
            color: white;
        }
        .content-table .actions-column .edit-btn {
            background-color: #ff9800;
        }
        .content-table .actions-column .delete-btn {
            background-color: #f44336;
        }
        .content-table .actions-column .edit-btn:hover { background-color: #e68a00; }
        .content-table .actions-column .delete-btn:hover { background-color: #d32f2f; }
        /* Estilos para el formulario de crear materia y registro de alumnos */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 7px; /* Padding reducido */
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        .form-group button {
            padding: 7px 14px; /* Padding reducido */
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        .form-group button:hover {
            background-color: var(--button-hover-bg);
        }
        /* Estilos para el recuadro de materias con checkboxes */
        .materias-checkbox-group {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            max-height: 150px; /* Altura máxima para scroll si hay muchas materias */
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        .materias-checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: normal; /* Override default label bold */
            cursor: pointer;
            color: var(--text-color);
        }
        .materias-checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2); /* Make checkbox slightly larger */
            cursor: pointer;
        }
        /* Alineación para noticias y eventos */
        .news-event-title {
            text-align: center;
            font-size: 1.3em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .news-event-heading {
            text-align: justify;
            font-weight: normal;
            font-size: 1em;
            color: var(--text-color);
        }
        /* Estilos para el portal del estudiante */
        .student-portal-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .materia-grade-card {
            background-color: #e6f0ff;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .materia-grade-card h4 {
            margin: 0;
            color: var(--dark-nav-color);
            font-size: 1em;
        }
        .materia-grade-card .grade-info {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1em;
        }
        .materia-grade-card button {
            padding: 6px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.3s ease;
        }
        .materia-grade-card button:hover {
            background-color: var(--button-hover-bg);
        }
        .filter-group {
            margin-bottom: 10px;
        }
        .filter-group label {
            font-weight: 600;
            color: var(--text-color);
            margin-right: 10px;
        }
        .filter-group select, .filter-group input[type="text"] { /* Added input[type="text"] */
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <main class="content">
            <section id="inicio" class="tab-content active">
                <h2><i class="fas fa-home" style="margin-right: 10px;"></i>Bienvenido a Volta</h2>
                <img src="novell.png" alt="Imagen de Novell" class="hero-image">
                <div id="news-events-display">
                    </div>
            </section>
            <section id="biblioteca" class="tab-content">
                <h2><i class="fas fa-book-open" style="margin-right: 10px;"></i>Biblioteca Digital</h2>
                <div id="library-access-required" style="text-align: center; padding: 5px;">
                    <img src="volta.png" alt="Volta Logo" style="max-width: 200px; margin-bottom: 5px; border-radius: 5px;">
                    <p style="color: var(--primary-color); font-weight: bold; font-size: 1.1em;">
                        ¡Acceso Restringido!
                    </p>
                    <p style="color: var(--muted-text-color);">
                        Para acceder a la biblioteca digital, por favor **inicia sesión** en tu cuenta de alumno
                        desde la pestaña **"Portal"**. Una vez que hayas iniciado sesión, podrás explorar todos nuestros recursos.
                    </p>
                </div>
                <div id="library-content" style="display: none;">
                    <p>Explora nuestros recursos digitales: libros, videos y software.</p>
                    <div class="button-group">
                        <button class="action-button" data-modal-target="#practicasModal">
                            <span class="button-icon"><i class="fas fa-flask"></i></span>
                            Prácticas
                        </button>
                        <button class="action-button" data-modal-target="#librosModal">
                            <span class="button-icon"><i class="fas fa-book"></i></span>
                            Libros
                        </button>
                        <button class="action-button" data-modal-target="#videosModal">
                            <span class="button-icon"><i class="fas fa-video"></i></span>
                            Videos
                        </button>
                        <button class="action-button" data-modal-target="#softwareModal">
                            <span class="button-icon"><i class="fas fa-code"></i></span>
                            Software
                        </button>
                    </div>
                </div>
            </section>
            <section id="portal" class="tab-content">
                <h2 id="portal-title"><i class="fas fa-user-circle" style="margin-right: 10px;"></i>Portal de Acceso</h2>
                <p id="portal-intro-text">Inicia sesión para acceder a tu perfil y funcionalidades avanzadas.</p>
                <div class="login-card" id="login-card">
                    <form id="login-form" class="login-form">
                        <label for="username">Usuario</label>
                        <div class="input-group">
                            <input type="text" id="username" name="username" placeholder="Tu nombre de usuario" required>
                        </div>
                        <label for="password">Contraseña</label>
                        <div class="input-group">
                            <input type="password" id="password" name="password" placeholder="Tu contraseña" required>
                            <span class="toggle-password" id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                        <button type="submit">Iniciar Sesión</button>
                    </form>
                </div>
                <div id="admin-panel-content" class="admin-button-group" style="display: none;">
                    </div>
                <div id="student-portal-content" class="student-portal-section" style="display: none;">
                    <h3>Bienvenido, <span id="student-portal-name"></span>!</h3>
                    <p>Tus materias registradas y calificaciones:</p>
                    <div id="student-materias-grades">
                        </div>
                    <button id="studentLogoutButton" class="admin-button logout-button">
                        <span class="button-icon"><i class="fas fa-sign-out-alt"></i></span> Cerrar Sesión
                    </button>
                </div>
            </section>
        </main>
        <nav class="bottom-nav">
            <button class="nav-item active" data-tab="inicio">
                <div class="icon"><i class="fas fa-home"></i></div>
                <span>Inicio</span>
            </button>
            <button class="nav-item" data-tab="biblioteca">
                <div class="icon"><i class="fas fa-book-open"></i></div>
                <span>Biblioteca</span>
            </button>
            <button class="nav-item" data-tab="portal">
                <div class="icon"><i class="fas fa-user-circle"></i></div>
                <span>Portal</span>
            </button>
        </nav>
    </div>
    <div id="noticiasModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-newspaper"></i> Noticias Recientes</h3>
                <span class="close-button">&times;</span>
            </div>
            <p>Aquí se mostrarán las últimas noticias y actualizaciones importantes.</p>
            <div class="modal-actions">
                <button class="close-btn close-button">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="eventosModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> Próximos Eventos</h3>
                <span class="close-button">&times;</span>
            </div>
            <p>Consulta el calendario de eventos, talleres y seminarios.</p>
            <div class="modal-actions">
                <button class="close-btn close-button">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="practicasModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-flask"></i> Prácticas Disponibles</h3>
                <span class="close-button">&times;</span>
            </div>
            <div class="filter-group">
                <label for="practicas-search">Buscar por título/descripción:</label>
                <input type="text" id="practicas-search" placeholder="Escribe para buscar..." oninput="filterLibraryItems('practica', this.value)">
            </div>
            <div id="practicas-list"></div>
            <div class="modal-actions">
                <button class="close-btn close-button">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="librosModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book"></i> Libros Disponibles</h3>
                <span class="close-button">&times;</span>
            </div>
            <div class="filter-group">
                <label for="libros-search">Buscar por título/descripción:</label>
                <input type="text" id="libros-search" placeholder="Escribe para buscar..." oninput="filterLibraryItems('libro', this.value)">
            </div>
            <div id="libros-list"></div>
            <div class="modal-actions">
                <button class="close-btn close-button">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="videosModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-video"></i> Videos Educativos</h3>
                <span class="close-button">&times;</span>
            </div>
            <div class="filter-group">
                <label for="videos-search">Buscar por título/descripción:</label>
                <input type="text" id="videos-search" placeholder="Escribe para buscar..." oninput="filterLibraryItems('video', this.value)">
            </div>
            <div id="videos-list"></div>
            <div class="modal-actions">
                <button class="close-btn close-button">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="softwareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-code"></i> Software y Herramientas</h3>
                <span class="close-button">&times;</span>
            </div>
            <div class="filter-group">
                <label for="software-search">Buscar por título/descripción:</label>
                <input type="text" id="software-search" placeholder="Escribe para buscar..." oninput="filterLibraryItems('software', this.value)">
            </div>
            <div id="software-list"></div>
            <div class="modal-actions">
                <button class="close-btn close-button">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="manageNewsEventsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bullhorn"></i> Gestionar Noticias y Eventos</h3>
                <span class="close-button">&times;</span>
            </div>
            <form id="news-event-form" class="form-group">
                <input type="hidden" id="news-event-id">
                <label for="news-event-type">Tipo:</label>
                <select id="news-event-type" required>
                    <option value="news">Noticia</option>
                    <option value="event">Evento</option>
                </select>
                <label for="news-event-title-input">Título:</label>
                <input type="text" id="news-event-title-input" placeholder="Título de la noticia/evento" required>
                <label for="news-event-heading-input">Encabezado/Contenido:</label>
                <textarea id="news-event-heading-input" rows="4" placeholder="Contenido detallado" required></textarea>
                <button type="submit">Guardar</button>
            </form>
            <h4 style="margin-top: 20px; color: var(--primary-color);">Noticias y Eventos Publicados</h4>
            <div class="table-responsive">
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Título</th>
                            <th>Contenido</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="news-events-admin-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="manageLibraryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-reader"></i> Gestionar Biblioteca</h3>
                <span class="close-button">&times;</span>
            </div>
            <form id="library-item-form" class="form-group">
                <input type="hidden" id="library-item-id">
                <label for="library-item-code-display">Nro.:</label>
                <input type="text" id="library-item-code-display" disabled style="background-color: #eee; cursor: not-allowed;">
                <label for="library-item-title">Título:</label>
                <input type="text" id="library-item-title" placeholder="Título del ítem" required>
                <label for="library-item-type">Tipo:</label>
                <select id="library-item-type" required>
                    <option value="practica">Práctica</option>
                    <option value="libro">Libro</option>
                    <option value="video">Video</option>
                    <option value="software">Software</option>
                </select>
                <label for="library-item-link">Link:</label>
                <input type="url" id="library-item-link" placeholder="URL del recurso" required>
                <label for="library-item-description">Descripción:</label>
                <textarea id="library-item-description" rows="3" placeholder="Descripción del recurso"></textarea>
                <button type="submit">Guardar</button>
            </form>
            <h4 style="margin-top: 20px; color: var(--primary-color);">Ítems de Biblioteca</h4>
            <div class="table-responsive">
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Nro.</th>
                            <th>Título</th>
                            <th>Tipo</th>
                            <th>Link</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="library-items-admin-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="createMateriaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chalkboard"></i> Crear Materia</h3>
                <span class="close-button">&times;</span>
            </div>
            <form id="create-materia-form" class="form-group">
                <input type="hidden" id="materia-id">
                <label for="materia-name">Nombre de la Materia:</label>
                <input type="text" id="materia-name" placeholder="Ej: Introducción a la Programación" required>
                <label for="ponderacion-asistencia">Ponderación Asistencia (%):</label>
                <input type="number" id="ponderacion-asistencia" min="0" max="100" value="10" required>
                <label for="ponderacion-practicas">Ponderación Prácticas (%):</label>
                <input type="number" id="ponderacion-practicas" min="0" max="100" value="40" required>
                <label for="ponderacion-parciales">Ponderación Parciales (%):</label>
                <input type="number" id="ponderacion-parciales" min="0" max="100" value="50" required>
                <button type="submit">Guardar Materia</button>
            </form>
            <h4 style="margin-top: 20px; color: var(--primary-color);">Materias Creadas</h4>
            <div class="table-responsive">
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Materia</th>
                            <th>Asistencia</th>
                            <th>Prácticas</th>
                            <th>Parciales</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="materias-admin-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="registerStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Registrar Alumno</h3>
                <span class="close-button">&times;</span>
            </div>
            <form id="register-student-form" class="form-group">
                <input type="hidden" id="student-id">
                <label for="student-paterno">Apellido Paterno:</label>
                <input type="text" id="student-paterno" placeholder="Apellido Paterno" required>
                <label for="student-materno">Apellido Materno:</label>
                <input type="text" id="student-materno" placeholder="Apellido Materno" required>
                <label for="student-nombres">Nombres:</label>
                <input type="text" id="student-nombres" placeholder="Nombres" required>
                <label for="student-celular">Número de Celular:</label>
                <input type="text" id="student-celular" placeholder="Ej: 77712345">
                <label>Materias (selecciona una o más):</label>
                <div id="student-materias-checkbox-group" class="materias-checkbox-group">
                    </div>
                <button type="submit">Guardar Alumno</button>
            </form>
            <h4 style="margin-top: 20px; color: var(--primary-color);">Alumnos Registrados</h4>
            <div class="table-responsive">
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Nombre Completo</th>
                            <th>Celular</th>
                            <th>Materias</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="students-admin-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="listMateriasModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-list-alt"></i> Lista de Materias</h3>
                <span class="close-button">&times;</span>
            </div>
            <div id="materias-list-buttons" class="admin-button-group">
                </div>
        </div>
    </div>
    <div id="studentGradesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="student-grades-title"><i class="fas fa-graduation-cap"></i> Calificaciones de Alumno</h3>
                <span class="close-button">&times;</span>
            </div>
            <p>Alumno: <strong id="current-student-name-grades-modal"></strong></p>
            <p>Materia: <strong id="current-materia-name-grades-modal"></strong></p>
            <form id="grade-form" class="form-group">
                <input type="hidden" id="grade-student-id">
                <input type="hidden" id="grade-materia-name">
                <label for="grade-asistencia">Asistencia:</label>
                <input type="number" id="grade-asistencia" min="0" max="100" placeholder="Puntaje de Asistencia">
                <div style="margin-top: 15px;">
                    <label>Prácticas (Puntaje 0-100):</label>
                    <div id="practicas-inputs" class="form-group" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        </div>
                </div>
                <div style="margin-top: 15px;">
                    <label>Parciales (Puntaje 0-100):</label>
                    <div id="parciales-inputs" class="form-group" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        </div>
                </div>
                <button type="submit">Guardar Calificaciones</button>
            </form>
        </div>
    </div>
    <div id="studentGradeDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-list"></i> Detalle de Calificaciones</h3>
                <span class="close-button">&times;</span>
            </div>
            <p>Alumno: <strong id="detail-student-name"></strong></p>
            <p>Materia: <strong id="detail-materia-name"></strong></p>
            <div id="grade-details-content">
                </div>
            <div class="modal-actions">
                <button class="close-btn close-button">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="messageBoxModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageBoxTitle"></h3>
                <span class="close-button" id="messageBoxCloseBtn">&times;</span>
            </div>
            <p id="messageBoxContent"></p>
            <div class="modal-actions">
                <button class="close-btn" id="messageBoxConfirmBtn">Aceptar</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        console.log("Script loaded and DOMContentLoaded event fired.");
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCoeIyKkUbtKLzpr0-FO9vkt9SqsMuQl_k",
            authDomain: "volta-77f5a.firebaseapp.com",
            projectId: "volta-77f5a",
            storageBucket: "volta-77f5a.appspot.com",
            messagingSenderId: "209382996934",
            appId: "1:209382996934:web:f85f1eccff138ee26a10c7"
        };
        // FIX: Corrected typo from __initialAuthToken to __initial_auth_token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null; // Will store the authenticated user ID
        let currentLoggedInStudent = null; // To store the currently logged-in student object
        let userIsLoggedIn = false; // New flag to track login status
        // --- Firebase Collections References ---
        const getCollectionRef = (collectionName) => {
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        };
        const newsCollection = getCollectionRef('news');
        const eventsCollection = getCollectionRef('events');
        const libraryItemsCollection = getCollectionRef('libraryItems');
        const materiasCollection = getCollectionRef('materias');
        const studentsCollection = getCollectionRef('students');
        // --- Data Storage (will be populated by Firestore listeners) ---
        let allNews = [];
        let allEvents = [];
        let allLibraryItems = [];
        let allMaterias = {}; // Keyed by lowercased materia name
        let allStudents = [];
        // --- DOM Elements (Declared globally) ---
        let navItems, tabContents, actionButtons, modals, closeButtons;
        let portalTitle, portalIntroText, loginCard, togglePassword, passwordInput, loginForm, adminPanelContent;
        let studentPortalContent, studentPortalName, studentMateriasGrades, studentLogoutButton;
        let manageNewsEventsModal, newsEventForm, newsEventIdInput, newsEventTypeInput, newsEventTitleInput, newsEventHeadingInput, newsEventsAdminTbody, newsEventsDisplay;
        let manageLibraryModal, libraryItemForm, libraryItemIdInput, libraryItemCodeDisplay, libraryItemTitleInput, libraryItemTypeSelect, libraryItemLinkInput, libraryItemDescriptionInput, libraryItemsAdminTbody;
        let createMateriaModal, createMateriaForm, materiaIdInput, materiaNameInput, ponderacionAsistenciaInput, ponderacionPracticasInput, ponderacionParcialesInput, materiasAdminTbody;
        let registerStudentModal, registerStudentForm, studentIdInput, studentPaternoInput, studentMaternoInput, studentNombresInput, studentCelularInput, studentMateriasCheckboxGroup, studentsAdminTbody;
        let listMateriasModal, materiasListButtons;
        let studentGradesModal, studentGradesTitle, currentStudentNameGradesModal, currentMateriaNameGradesModal, gradeForm, gradeStudentIdInput, gradeMateriaNameInput, gradeAsistenciaInput, practicasInputsDiv, parcialesInputsDiv;
        let studentGradeDetailModal, detailStudentName, detailMateriaName, gradeDetailsContent;
        let practicasSearchInput, librosSearchInput, videosSearchInput, softwareSearchInput;
        let libraryAccessRequiredDiv;
        let libraryContentDiv;
        // Custom message box function (updated to include a callback for confirmation)
        function showMessageBox(title, message, type = 'alert', callback = null) {
            const modal = document.getElementById('messageBoxModal');
            document.getElementById('messageBoxTitle').textContent = title;
            document.getElementById('messageBoxContent').textContent = message;
            const confirmBtn = document.getElementById('messageBoxConfirmBtn');
            const closeBtn = document.getElementById('messageBoxCloseBtn');
            // Reset event listeners to prevent multiple bindings
            const cloneConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(cloneConfirmBtn, confirmBtn);
            const newConfirmBtn = cloneConfirmBtn;
            const cloneCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(cloneCloseBtn, closeBtn);
            const newCloseBtn = cloneCloseBtn;
            // Show/hide confirm button based on type
            if (type === 'confirm') {
                newConfirmBtn.style.display = 'inline-block';
                newConfirmBtn.textContent = 'Sí, eliminar'; // Specific text for delete confirmation
            } else {
                newConfirmBtn.style.display = 'inline-block'; // Always show for 'alert'
                newConfirmBtn.textContent = 'Aceptar';
            }
            const closeHandler = () => {
                modal.style.display = 'none';
                newConfirmBtn.removeEventListener('click', confirmClickHandler);
                newCloseBtn.removeEventListener('click', closeClickHandler);
                modal.onclick = null; // Remove outside click listener
            };
            const confirmClickHandler = () => {
                closeHandler();
                if (callback) {
                    callback(true); // Indicate confirmation
                }
            };
            const closeClickHandler = () => {
                closeHandler();
                if (callback && type === 'confirm') {
                    callback(false); // Indicate cancellation for confirm type
                }
            };
            newConfirmBtn.addEventListener('click', confirmClickHandler);
            newCloseBtn.addEventListener('click', closeClickHandler);
            modal.onclick = (event) => {
                if (event.target === modal && modal.id !== 'messageBoxModal') { 
                    closeHandler();
                }
            };
            modal.style.display = 'block';
        }
        // --- Firebase Setup and Auth ---
        async function setupFirebaseAndAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Auth state changed. User ID:", userId);
                        setupFirestoreListeners();
                    } else {
                        userId = null;
                        console.log("User is signed out.");
                    }
                });
            } catch (error) {
                console.error("Error during Firebase authentication:", error);
                showMessageBox('Error de Autenticación', 'No se pudo iniciar sesión en Firebase. Algunas funciones podrían no estar disponibles.');
            }
        }
        // --- Firestore Listeners ---
        function setupFirestoreListeners() {
            // Listener for News
            onSnapshot(newsCollection, (snapshot) => {
                try {
                    allNews = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return { id: doc.id, ...data };
                    });
                    console.log("✅ News loaded successfully. Count:", allNews.length);
                    renderNewsEvents();
                    renderAdminNewsEventsTable();
                } catch (error) {
                    console.error("❌ Error processing news data:", error);
                    showMessageBox('Error de Carga', 'No se pudieron cargar las noticias.');
                }
            }, (error) => {
                console.error("❌ Error fetching news from Firestore:", error);
                showMessageBox('Error de Carga', 'No se pudieron cargar las noticias.');
            });
            // Listener for Events
            onSnapshot(eventsCollection, (snapshot) => {
                try {
                    allEvents = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return { id: doc.id, ...data };
                    });
                    console.log("✅ Events loaded successfully. Count:", allEvents.length);
                    renderNewsEvents();
                    renderAdminNewsEventsTable();
                } catch (error) {
                    console.error("❌ Error processing events data:", error);
                    showMessageBox('Error de Carga', 'No se pudieron cargar los eventos.');
                }
            }, (error) => {
                console.error("❌ Error fetching events from Firestore:", error);
                showMessageBox('Error de Carga', 'No se pudieron cargar los eventos.');
            });
            // Listener for Library Items
            onSnapshot(libraryItemsCollection, (snapshot) => {
                try {
                    allLibraryItems = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return { id: doc.id, ...data };
                    });
                    // Sort by the new numerical code
                    allLibraryItems.sort((a, b) => a.code - b.code);
                    console.log("✅ Library Items loaded and sorted. Count:", allLibraryItems.length);
                    renderAdminLibraryItemsTable();
                    renderLibraryItemsInModals();
                } catch (error) {
                    console.error("❌ Error processing library items data:", error);
                    showMessageBox('Error de Carga', 'No se pudieron cargar los ítems de la biblioteca.');
                }
            }, (error) => {
                console.error("❌ Error fetching library items from Firestore:", error);
                showMessageBox('Error de Carga', 'No se pudieron cargar los ítems de la biblioteca.');
            });
            // Listener for Materias (Subjects)
            onSnapshot(materiasCollection, (snapshot) => {
                try {
                    allMaterias = {}; // Clear previous data
                    snapshot.docs.forEach(doc => {
                        const materiaData = { id: doc.id, ...doc.data() };
                        // Robust handling: Only add if 'name' field exists and is a string
                        if (materiaData.name && typeof materiaData.name === 'string') {
                            allMaterias[materiaData.name.toLowerCase()] = materiaData;
                        } else {
                            console.warn("⚠️ Documento de materia sin nombre válido encontrado:", doc.id, materiaData);
                        }
                    });
                    console.log("✅ Materias loaded successfully. Count:", Object.keys(allMaterias).length);
                    renderAdminMateriasTable();
                    populateStudentMateriasCheckboxes();
                    renderMateriasListButtons();
                    if (currentLoggedInStudent) {
                        renderStudentPortal();
                    }
                } catch (error) {
                    console.error("❌ Error processing materias data:", error);
                    showMessageBox('Error de Carga', 'No se pudieron cargar las materias.');
                }
            }, (error) => {
                console.error("❌ Error fetching materias from Firestore:", error);
                showMessageBox('Error de Carga', 'No se pudieron cargar las materias.');
            });
            // Listener for Students
            onSnapshot(studentsCollection, (snapshot) => {
                try {
                    allStudents = snapshot.docs.map(doc => {
                        const data = doc.data();
                        // Ensure 'enrolledMaterias' is always an array
                        if (!Array.isArray(data.enrolledMaterias)) {
                            data.enrolledMaterias = [];
                        }
                        // Ensure 'grades' is always an object
                        if (typeof data.grades !== 'object' || data.grades === null) {
                            data.grades = {};
                        }
                        return { id: doc.id, ...data };
                    });
                    console.log("✅ Students loaded successfully. Count:", allStudents.length);
                    renderAdminStudentsTable();
                    if (currentLoggedInStudent) {
                        const updatedStudent = allStudents.find(s => s.id === currentLoggedInStudent.id);
                        if (updatedStudent) {
                            currentLoggedInStudent = updatedStudent;
                            renderStudentPortal();
                        } else {
                            currentLoggedInStudent = null;
                            studentPortalContent.style.display = 'none';
                            loginCard.style.display = 'block';
                            portalIntroText.style.display = 'block';
                            portalTitle.textContent = 'Portal de Acceso';
                            userIsLoggedIn = false;
                            updateLibraryTabContentVisibility();
                            showMessageBox('Sesión Terminada', 'Tu cuenta de estudiante ha sido eliminada o modificada. Por favor, inicia sesión de nuevo.');
                        }
                    }
                } catch (error) {
                    console.error("❌ Error processing students data:", error);
                    showMessageBox('Error de Carga', 'No se pudieron cargar los datos de los alumnos.');
                }
            }, (error) => {
                console.error("❌ Error fetching students from Firestore:", error);
                showMessageBox('Error de Carga', 'No se pudieron cargar los datos de los alumnos.');
            });
        }
        // --- Admin: Manage News and Events ---
        async function handleNewsEventFormSubmit(e) {
            e.preventDefault();
            const id = newsEventIdInput.value;
            const type = newsEventTypeInput.value;
            const title = newsEventTitleInput.value;
            const heading = newsEventHeadingInput.value;
            const newItem = { type, title, heading };
            console.log("Intentando guardar/actualizar noticia/evento:", newItem);
            try {
                const targetCollection = type === 'news' ? newsCollection : eventsCollection;
                if (id) {
                    await setDoc(doc(targetCollection, id), newItem);
                } else {
                    await addDoc(targetCollection, newItem);
                }
                newsEventForm.reset();
                newsEventIdInput.value = '';
                showMessageBox('Éxito', 'Noticia/Evento guardado con éxito.');
            } catch (e) {
                console.error("Error al añadir/actualizar documento: ", e);
                showMessageBox('Error', 'Error al guardar la noticia/evento. Por favor, inténtalo de nuevo.');
            }
        }
        function renderAdminNewsEventsTable() {
            newsEventsAdminTbody.innerHTML = '';
            const allCombinedNewsEvents = [...allNews, ...allEvents].sort((a, b) => {
                if (a.type === b.type) {
                    return a.title.localeCompare(b.title);
                }
                return a.type === 'news' ? -1 : 1;
            });
            if (allCombinedNewsEvents.length === 0) {
                newsEventsAdminTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted-text-color);">No hay noticias o eventos registrados.</td></tr>';
                return;
            }
            allCombinedNewsEvents.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.type === 'news' ? 'Noticia' : 'Evento'}</td>
                    <td style="text-align: center;">${item.title}</td>
                    <td style="text-align: justify;">${item.heading}</td>
                    <td class="actions-column">
                        <button class="edit-btn" data-id="${item.id}" data-type="${item.type}">Editar</button>
                        <button class="delete-btn" data-id="${item.id}" data-type="${item.type}">Eliminar</button>
                    </td>
                `;
                newsEventsAdminTbody.appendChild(tr);
            });
            newsEventsAdminTbody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const item = [...allNews, ...allEvents].find(n => n.id === id);
                    if (item) {
                        newsEventIdInput.value = item.id;
                        newsEventTypeInput.value = item.type;
                        newsEventTitleInput.value = item.title;
                        newsEventHeadingInput.value = item.heading;
                    }
                });
            });
            newsEventsAdminTbody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const type = e.target.dataset.type;
                    showMessageBox('Confirmar Eliminación', '¿Estás seguro de que quieres eliminar este elemento?', 'confirm', async (confirmed) => {
                        if (confirmed) {
                            try {
                                const targetCollection = type === 'news' ? newsCollection : eventsCollection;
                                await deleteDoc(doc(targetCollection, id));
                                showMessageBox('Éxito', 'Elemento eliminado con éxito.');
                            } catch (error) {
                                console.error("Error al eliminar documento de Firebase: ", error);
                                showMessageBox('Error', 'Error al eliminar el documento. Por favor, inténtalo de nuevo.');
                            }
                        }
                    });
                });
            });
        }
        function renderNewsEvents() {
            newsEventsDisplay.innerHTML = '';
            const allCombinedNewsEvents = [...allNews, ...allEvents].sort((a, b) => a.id.localeCompare(b.id));
            if (allCombinedNewsEvents.length === 0) {
                newsEventsDisplay.innerHTML = '<p style="text-align: center; color: var(--muted-text-color);">No hay noticias o eventos para mostrar.</p>';
            } else {
                allCombinedNewsEvents.forEach(item => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '20px';
                    div.innerHTML = `
                        <h3 class="news-event-title">${item.title}</h3>
                        <p class="news-event-heading">${item.heading}</p>
                    `;
                    newsEventsDisplay.appendChild(div);
                });
            }
        }
        // --- Admin: Manage Library Items ---
        async function handleLibraryItemFormSubmit(e) {
            e.preventDefault();
            const id = libraryItemIdInput.value;
            const title = libraryItemTitleInput.value;
            const type = libraryItemTypeSelect.value;
            const link = libraryItemLinkInput.value;
            const description = libraryItemDescriptionInput.value;
            let code;
            if (id) {
                const existingItem = allLibraryItems.find(item => item.id === id);
                if (!existingItem) {
                    showMessageBox('Error', 'No se encontró el ítem para actualizar.');
                    return;
                }
                code = existingItem.code;
            } else {
                code = allLibraryItems.length > 0 ? Math.max(...allLibraryItems.map(item => item.code)) + 1 : 1;
            }
            const newItem = { code, title, type, link, description };
            console.log("Intentando guardar/actualizar ítem de biblioteca:", newItem);
            try {
                if (id) {
                    await setDoc(doc(libraryItemsCollection, id), newItem);
                } else {
                    await addDoc(libraryItemsCollection, newItem);
                }
                libraryItemForm.reset();
                libraryItemIdInput.value = '';
                const nextCode = allLibraryItems.length + 1;
                libraryItemCodeDisplay.value = nextCode;
                showMessageBox('Éxito', 'Ítem de biblioteca guardado con éxito.');
            } catch (e) {
                console.error("Error al añadir/actualizar ítem de biblioteca: ", e);
                showMessageBox('Error', 'Error al guardar el ítem de biblioteca. Por favor, inténtalo de nuevo.');
            }
        }
        function renderAdminLibraryItemsTable() {
            libraryItemsAdminTbody.innerHTML = '';
            if (allLibraryItems.length === 0) {
                libraryItemsAdminTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--muted-text-color);">No hay ítems de biblioteca registrados.</td></tr>';
                return;
            }
            allLibraryItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.title}</td>
                    <td>${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</td>
                    <td><a href="${item.link}" target="_blank">Ver recurso</a></td>
                    <td class="actions-column">
                        <button class="edit-btn" data-id="${item.id}">Editar</button>
                        <button class="delete-btn" data-id="${item.id}">Eliminar</button>
                    </td>
                `;
                libraryItemsAdminTbody.appendChild(tr);
            });
            libraryItemsAdminTbody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const item = allLibraryItems.find(n => n.id === id);
                    if (item) {
                        libraryItemIdInput.value = item.id;
                        libraryItemCodeDisplay.value = item.code;
                        libraryItemTitleInput.value = item.title;
                        libraryItemTypeSelect.value = item.type;
                        libraryItemLinkInput.value = item.link;
                        libraryItemDescriptionInput.value = item.description;
                    }
                });
            });
            libraryItemsAdminTbody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    showMessageBox('Confirmar Eliminación', '¿Estás seguro de que quieres eliminar este ítem? Los ítems restantes se re-numerarán.', 'confirm', async (confirmed) => {
                        if (confirmed) {
                            const itemToDelete = allLibraryItems.find(item => item.id === id);
                            if (!itemToDelete) {
                                showMessageBox('Error', 'No se pudo encontrar el ítem a eliminar.');
                                return;
                            }
                            const deletedItemCode = itemToDelete.code;
                            try {
                                const batch = writeBatch(db);
                                const docToDeleteRef = doc(libraryItemsCollection, id);
                                batch.delete(docToDeleteRef);
                                const itemsToUpdate = allLibraryItems.filter(item => item.code > deletedItemCode);
                                itemsToUpdate.forEach(item => {
                                    const itemRef = doc(libraryItemsCollection, item.id);
                                    const newCode = item.code - 1;
                                    batch.update(itemRef, { code: newCode });
                                });
                                await batch.commit();
                                showMessageBox('Éxito', 'Ítem eliminado y re-enumerado con éxito.');
                            } catch (error) {
                                console.error("Error durante la eliminación en lote: ", error);
                                showMessageBox('Error', 'Error al eliminar el ítem de la biblioteca.');
                            }
                        }
                    });
                });
            });
        }
        window.filterLibraryItems = function(type, searchQuery) {
            renderLibraryItemsInModals(type, searchQuery);
        };
        function renderLibraryItemsInModals(targetType = null, searchQuery = '') {
            document.getElementById('practicas-list').innerHTML = '';
            document.getElementById('libros-list').innerHTML = '';
            document.getElementById('videos-list').innerHTML = '';
            document.getElementById('software-list').innerHTML = '';
            const groupedItems = { practica: [], libro: [], video: [], software: [] };
            allLibraryItems.forEach(item => {
                if (groupedItems[item.type]) {
                    groupedItems[item.type].push(item);
                }
            });
            for (const type in groupedItems) {
                const containerId = `${type}s-list`;
                const container = document.getElementById(containerId);
                if (targetType && targetType !== type) {
                    continue;
                }
                let itemsToRender = groupedItems[type];
                if (searchQuery) {
                    const lowerCaseQuery = searchQuery.toLowerCase();
                    itemsToRender = itemsToRender.filter(item =>
                        (item.title && item.title.toLowerCase().includes(lowerCaseQuery)) ||
                        (item.description && item.description.toLowerCase().includes(lowerCaseQuery))
                    );
                }
                if (container) {
                    if (itemsToRender.length === 0) {
                        container.innerHTML = `<p style="text-align: center; color: var(--muted-text-color);">No hay ${type}s para mostrar.</p>`;
                    } else {
                        let tableHTML = `
                            <div class="table-responsive">
                                <table class="content-table">
                                    <thead>
                                        <tr>
                                            <th>Nro.</th>
                                            <th>Título</th>
                                            <th>Descripción</th>
                                            <th>Recurso</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                        itemsToRender.forEach(item => {
                            const displayLink = item.link ? `<a href="${item.link}" target="_blank">Ver recurso</a>` : 'N/A';
                            tableHTML += `
                                    <tr>
                                        <td>${item.code}</td>
                                        <td>${item.title}</td>
                                        <td>${item.description || 'N/A'}</td>
                                        <td>${displayLink}</td>
                                    </tr>
                                `;
                        });
                        tableHTML += `
                                    </tbody>
                                </table>
                            </div>
                            `;
                        container.innerHTML = tableHTML;
                    }
                }
            }
        }
        // --- Admin: Create Materia ---
        async function handleCreateMateriaFormSubmit(e) {
            e.preventDefault();
            const id = materiaIdInput.value;
            const name = materiaNameInput.value.trim();
            const nameKey = name.toLowerCase();
            const ponderacionAsistencia = parseInt(ponderacionAsistenciaInput.value);
            const ponderacionPracticas = parseInt(ponderacionPracticasInput.value);
            const ponderacionParciales = parseInt(ponderacionParcialesInput.value);
            if (ponderacionAsistencia + ponderacionPracticas + ponderacionParciales !== 100) {
                showMessageBox('Error de Ponderación', 'La suma de las ponderaciones debe ser 100%.');
                return;
            }
            const newMateriaData = {
                name: name,
                ponderaciones: {
                    asistencia: ponderacionAsistencia,
                    practicas: ponderacionPracticas,
                    parciales: ponderacionParciales
                }
            };
            try {
                if (id) {
                    await setDoc(doc(materiasCollection, id), newMateriaData);
                } else {
                    if (allMaterias[nameKey]) {
                        showMessageBox('Materia Existente', 'Ya existe una materia con este nombre.');
                        return;
                    }
                    await addDoc(materiasCollection, newMateriaData);
                }
                createMateriaForm.reset();
                materiaIdInput.value = '';
                showMessageBox('Éxito', 'Materia guardada con éxito.');
            } catch (e) {
                console.error("Error al añadir/actualizar materia: ", e);
                showMessageBox('Error', 'Error al guardar la materia. Por favor, inténtalo de nuevo.');
            }
        }
        function renderAdminMateriasTable() {
            materiasAdminTbody.innerHTML = '';
            const materiasArray = Object.values(allMaterias);
            if (materiasArray.length === 0) {
                materiasAdminTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--muted-text-color);">No hay materias registradas.</td></tr>';
                return;
            }
            materiasArray.forEach(materia => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${materia.name}</td>
                    <td>${materia.ponderaciones.asistencia}%</td>
                    <td>${materia.ponderaciones.practicas}%</td>
                    <td>${materia.ponderaciones.parciales}%</td>
                    <td class="actions-column">
                        <button class="edit-btn" data-id="${materia.id}">Editar</button>
                        <button class="delete-btn" data-id="${materia.id}">Eliminar</button>
                    </td>
                `;
                materiasAdminTbody.appendChild(tr);
            });
            materiasAdminTbody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const materia = Object.values(allMaterias).find(m => m.id === id);
                    if (materia) {
                        materiaIdInput.value = materia.id;
                        materiaNameInput.value = materia.name;
                        ponderacionAsistenciaInput.value = materia.ponderaciones.asistencia;
                        ponderacionPracticasInput.value = materia.ponderaciones.practicas;
                        ponderacionParcialesInput.value = materia.ponderaciones.parciales;
                    }
                });
            });
            materiasAdminTbody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const materiaToDelete = Object.values(allMaterias).find(m => m.id === id);
                    if (materiaToDelete) {
                        const materiaNameKey = materiaToDelete.name.toLowerCase();
                        showMessageBox('Confirmar Eliminación', '¿Estás seguro de que quieres eliminar esta materia? Esto también eliminará las calificaciones de los alumnos en esta materia.', 'confirm', async (confirmed) => {
                            if (confirmed) {
                                try {
                                    await deleteDoc(doc(materiasCollection, id));
                                    for (const student of allStudents) {
                                        if (student.enrolledMaterias.includes(materiaNameKey)) {
                                            const updatedEnrolledMaterias = student.enrolledMaterias.filter(m => m !== materiaNameKey);
                                            const updatedGrades = { ...student.grades };
                                            delete updatedGrades[materiaNameKey];
                                            await updateDoc(doc(studentsCollection, student.id), {
                                                enrolledMaterias: updatedEnrolledMaterias,
                                                grades: updatedGrades
                                            });
                                        }
                                    }
                                    showMessageBox('Éxito', 'Materia y datos asociados eliminados con éxito.');
                                } catch (error) {
                                    console.error("Error al eliminar materia de Firebase: ", error);
                                    showMessageBox('Error', 'Error al eliminar la materia. Por favor, inténtalo de nuevo.');
                                }
                            }
                        });
                    }
                });
            });
        }
        // --- Admin: Register Student ---
        function populateStudentMateriasCheckboxes() {
            studentMateriasCheckboxGroup.innerHTML = '';
            const materiasArray = Object.values(allMaterias);
            if (materiasArray.length === 0) {
                studentMateriasCheckboxGroup.innerHTML = '<p style="color: var(--muted-text-color);">No hay materias disponibles para registrar alumnos.</p>';
                return;
            }
            materiasArray.forEach(materia => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'student-materia';
                checkbox.value = materia.name.toLowerCase();
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(materia.name));
                studentMateriasCheckboxGroup.appendChild(label);
            });
        }
        async function handleRegisterStudentFormSubmit(e) {
            e.preventDefault();
            const id = studentIdInput.value;
            const paterno = studentPaternoInput.value.trim();
            const materno = studentMaternoInput.value.trim();
            const nombres = studentNombresInput.value.trim();
            const celular = studentCelularInput.value.trim();
            const selectedMateriasCheckboxes = Array.from(studentMateriasCheckboxGroup.querySelectorAll('input[type="checkbox"]:checked'));
            const selectedMaterias = selectedMateriasCheckboxes.map(checkbox => checkbox.value);
            let studentGrades = {};
            if (id) {
                const existingStudent = allStudents.find(s => s.id === id);
                if (existingStudent) {
                    studentGrades = existingStudent.grades;
                }
            }
            selectedMaterias.forEach(materiaName => {
                if (!studentGrades[materiaName]) {
                    studentGrades[materiaName] = {
                        asistencia: null,
                        practicas: Array(6).fill(null),
                        parciales: Array(2).fill(null)
                    };
                }
            });
            Object.keys(studentGrades).forEach(materiaName => {
                if (!selectedMaterias.includes(materiaName)) {
                    delete studentGrades[materiaName];
                }
            });
            const newStudentData = {
                paterno,
                materno,
                nombres,
                celular,
                enrolledMaterias: selectedMaterias,
                grades: studentGrades
            };
            try {
                if (id) {
                    await setDoc(doc(studentsCollection, id), newStudentData);
                } else {
                    await addDoc(studentsCollection, newStudentData);
                }
                registerStudentForm.reset();
                studentIdInput.value = '';
                studentMateriasCheckboxGroup.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                showMessageBox('Éxito', 'Alumno guardado con éxito.');
            } catch (e) {
                console.error("Error al añadir/actualizar alumno: ", e);
                showMessageBox('Error', 'Error al guardar el alumno. Por favor, inténtalo de nuevo.');
            }
        }
        function renderAdminStudentsTable() {
            studentsAdminTbody.innerHTML = '';
            if (allStudents.length === 0) {
                studentsAdminTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted-text-color);">No hay alumnos registrados.</td></tr>';
                return;
            }
            allStudents.forEach(student => {
                const enrolledMateriasNames = student.enrolledMaterias.map(materiaKey => {
                    const materiaData = allMaterias[materiaKey];
                    return materiaData ? materiaData.name : materiaKey;
                }).join(', ');
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student.nombres} ${student.paterno} ${student.materno}</td>
                    <td>${student.celular || 'N/A'}</td>
                    <td>${enrolledMateriasNames || 'Ninguna'}</td>
                    <td class="actions-column">
                        <button class="edit-btn" data-id="${student.id}">Editar</button>
                        <button class="delete-btn" data-id="${student.id}">Eliminar</button>
                    </td>
                `;
                studentsAdminTbody.appendChild(tr);
            });
            studentsAdminTbody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const student = allStudents.find(s => s.id === id);
                    if (student) {
                        studentIdInput.value = student.id;
                        studentPaternoInput.value = student.paterno;
                        studentMaternoInput.value = student.materno;
                        studentNombresInput.value = student.nombres;
                        studentCelularInput.value = student.celular;
                        populateStudentMateriasCheckboxes();
                        student.enrolledMaterias.forEach(enrolledMateria => {
                            const checkbox = studentMateriasCheckboxGroup.querySelector(`input[type="checkbox"][value="${enrolledMateria}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                });
            });
            studentsAdminTbody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    showMessageBox('Confirmar Eliminación', '¿Estás seguro de que quieres eliminar este alumno?', 'confirm', async (confirmed) => {
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(studentsCollection, id));
                                showMessageBox('Éxito', 'Alumno eliminado con éxito.');
                            }
                            catch (error) {
                                console.error("Error al eliminar alumno de Firebase: ", error);
                                showMessageBox('Error', 'Error al eliminar el alumno. Por favor, inténtalo de nuevo.');
                            }
                        }
                    });
                });
            });
        }
        // --- Admin: List Materias and Grades ---
        function renderMateriasListButtons() {
            materiasListButtons.innerHTML = '';
            const materiasArray = Object.values(allMaterias);
            if (materiasArray.length === 0) {
                materiasListButtons.innerHTML = '<p style="text-align: center; color: var(--muted-text-color);">No hay materias para gestionar calificaciones.</p>';
                return;
            }
            materiasArray.forEach(materia => {
                const button = document.createElement('button');
                button.className = 'admin-button';
                button.innerHTML = `<span class="button-icon"><i class="fas fa-chalkboard"></i></span> ${materia.name}`;
                button.dataset.materiaName = materia.name.toLowerCase();
                button.addEventListener('click', openStudentListForMateria);
                materiasListButtons.appendChild(button);
            });
        }
        function openStudentListForMateria(e) {
            const materiaName = e.currentTarget.dataset.materiaName;
            const materiaData = allMaterias[materiaName];
            if (!materiaData) {
                showMessageBox('Error', 'No se encontró la materia.');
                return;
            }
            const studentListModal = document.createElement('div');
            studentListModal.className = 'modal';
            studentListModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-users"></i> Alumnos de ${materiaData.name}</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="table-responsive">
                        <table class="content-table">
                            <thead>
                                <tr>
                                    <th>Nombre del Alumno</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="materia-students-tbody"></tbody>
                        </table>
                    </div>
                    <div class="modal-actions">
                        <button class="close-btn close-button">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(studentListModal);
            studentListModal.style.display = 'block';
            studentListModal.querySelector('.close-button').onclick = () => document.body.removeChild(studentListModal);
            studentListModal.querySelector('.close-btn').onclick = () => document.body.removeChild(studentListModal);
            const materiaStudentsTbody = studentListModal.querySelector('#materia-students-tbody');
            const studentsInMateria = allStudents.filter(student => student.enrolledMaterias.includes(materiaName));
            if (studentsInMateria.length === 0) {
                materiaStudentsTbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--muted-text-color);">No hay alumnos registrados en esta materia.</td></tr>';
            } else {
                studentsInMateria.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${student.nombres} ${student.paterno} ${student.materno}</td>
                        <td class="actions-column">
                            <button class="edit-btn grade-student-btn" data-student-id="${student.id}" data-materia-name="${materiaName}">Calificar</button>
                        </td>
                    `;
                    materiaStudentsTbody.appendChild(tr);
                });
                studentListModal.querySelectorAll('.grade-student-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const studentId = e.target.dataset.studentId;
                        const materiaName = e.target.dataset.materiaName;
                        openStudentGradesModal(studentId, materiaName);
                        document.body.removeChild(studentListModal);
                    });
                });
            }
        }
        function openStudentGradesModal(studentId, materiaName) {
            const student = allStudents.find(s => s.id === studentId);
            const materia = allMaterias[materiaName];
            if (!student || !materia) {
                showMessageBox('Error', 'Error: Alumno o materia no encontrados.');
                return;
            }
            studentGradesModal.style.display = 'block';
            currentStudentNameGradesModal.textContent = `${student.nombres} ${student.paterno} ${student.materno}`;
            currentMateriaNameGradesModal.textContent = materia.name;
            gradeStudentIdInput.value = studentId;
            gradeMateriaNameInput.value = materiaName;
            const studentMateriaGrades = student.grades[materiaName] || { asistencia: null, practicas: Array(6).fill(null), parciales: Array(2).fill(null) };
            gradeAsistenciaInput.value = studentMateriaGrades.asistencia !== null ? studentMateriaGrades.asistencia : '';
            practicasInputsDiv.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.max = '100';
                input.placeholder = `Práctica ${i + 1}`;
                input.id = `practica-${i}`;
                input.value = studentMateriaGrades.practicas[i] !== null ? studentMateriaGrades.practicas[i] : '';
                practicasInputsDiv.appendChild(input);
            }
            parcialesInputsDiv.innerHTML = '';
            for (let i = 0; i < 2; i++) {
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.max = '100';
                input.placeholder = `Parcial ${i + 1}`;
                input.id = `parcial-${i}`;
                input.value = studentMateriaGrades.parciales[i] !== null ? studentMateriaGrades.parciales[i] : '';
                parcialesInputsDiv.appendChild(input);
            }
        }
        async function handleGradeFormSubmit(e) {
            e.preventDefault();
            const studentId = gradeStudentIdInput.value;
            const materiaName = gradeMateriaNameInput.value;
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                showMessageBox('Error', 'Alumno no encontrado.');
                return;
            }
            const newAsistencia = gradeAsistenciaInput.value !== '' ? parseInt(gradeAsistenciaInput.value) : null;
            const newPracticas = [];
            for (let i = 0; i < 6; i++) {
                const input = document.getElementById(`practica-${i}`);
                newPracticas.push(input.value !== '' ? parseInt(input.value) : null);
            }
            const newParciales = [];
            for (let i = 0; i < 2; i++) {
                const input = document.getElementById(`parcial-${i}`);
                newParciales.push(input.value !== '' ? parseInt(input.value) : null);
            }
            const updatedGrades = {
                ...student.grades,
                [materiaName]: {
                    asistencia: newAsistencia,
                    practicas: newPracticas,
                    parciales: newParciales
                }
            };
            try {
                await updateDoc(doc(studentsCollection, student.id), {
                    grades: updatedGrades
                });
                showMessageBox('Éxito', 'Calificaciones guardadas con éxito.');
                studentGradesModal.style.display = 'none';
            } catch (error) {
                console.error("Error al guardar calificaciones: ", error);
                showMessageBox('Error', 'Error al guardar las calificaciones. Por favor, inténtalo de nuevo.');
            }
        }
        // --- Student Portal Functions ---
        function renderStudentPortal() {
            studentMateriasGrades.innerHTML = '';
            if (!currentLoggedInStudent) return;
            if (currentLoggedInStudent.enrolledMaterias.length === 0) {
                studentMateriasGrades.innerHTML = '<p style="text-align: center; color: var(--muted-text-color);">No estás inscrito en ninguna materia.</p>';
                return;
            }
            currentLoggedInStudent.enrolledMaterias.forEach(materiaNameKey => {
                const materia = allMaterias[materiaNameKey];
                if (materia) {
                    const overallGrade = calculateOverallGrade(currentLoggedInStudent, materiaNameKey);
                    const gradeDisplay = overallGrade !== null ? overallGrade.toFixed(2) : 'N/A';
                    const card = document.createElement('div');
                    card.className = 'materia-grade-card';
                    card.innerHTML = `
                        <div>
                            <h4>${materia.name}</h4>
                            <p>Calificación General: <span class="grade-info">${gradeDisplay}</span></p>
                        </div>
                        <button class="view-grades-detail-btn" data-materia-name="${materiaNameKey}">Calificación</button>
                    `;
                    studentMateriasGrades.appendChild(card);
                }
            });
            document.querySelectorAll('.view-grades-detail-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const materiaName = e.target.dataset.materiaName;
                    openStudentGradeDetailModal(currentLoggedInStudent.id, materiaName);
                });
            });
        }
        function calculateOverallGrade(student, materiaNameKey) {
            const materia = allMaterias[materiaNameKey];
            const studentGrades = student.grades[materiaNameKey];
            if (!materia || !studentGrades) {
                return null;
            }
            let totalGrade = 0;
            let hasValidGrades = false;
            if (studentGrades.asistencia !== null) {
                totalGrade += (studentGrades.asistencia * (materia.ponderaciones.asistencia / 100));
                hasValidGrades = true;
            }
            const validPracticas = studentGrades.practicas.filter(grade => grade !== null);
            if (validPracticas.length > 0) {
                const avgPracticas = validPracticas.reduce((sum, grade) => sum + grade, 0) / validPracticas.length;
                totalGrade += (avgPracticas * (materia.ponderaciones.practicas / 100));
                hasValidGrades = true;
            }
            const validParciales = studentGrades.parciales.filter(grade => grade !== null);
            if (validParciales.length > 0) {
                const avgParciales = validParciales.reduce((sum, grade) => sum + grade, 0) / validParciales.length;
                totalGrade += (avgParciales * (materia.ponderaciones.parciales / 100));
                hasValidGrades = true;
            }
            return hasValidGrades ? totalGrade : null;
        }
        function openStudentGradeDetailModal(studentId, materiaName) {
            const student = allStudents.find(s => s.id === studentId);
            const materia = allMaterias[materiaName];
            if (!student || !materia) {
                showMessageBox('Error', 'Alumno o materia no encontrados para el detalle de calificaciones.');
                return;
            }
            const studentMateriaGrades = student.grades[materiaName] || { asistencia: null, practicas: Array(6).fill(null), parciales: Array(2).fill(null) };
            detailStudentName.textContent = `${student.nombres} ${student.paterno} ${student.materno}`;
            detailMateriaName.textContent = materia.name;
            let detailsHTML = `
                <p><strong>Asistencia:</strong> ${studentMateriaGrades.asistencia !== null ? studentMateriaGrades.asistencia : 'N/A'}</p>
                <h4>Detalle de Prácticas:</h4>
                <ul>
            `;
            studentMateriaGrades.practicas.forEach((grade, index) => {
                detailsHTML += `<li>Práctica ${index + 1}: ${grade !== null ? grade : 'N/A'}</li>`;
            });
            detailsHTML += `
                </ul>
                <h4>Detalle de Parciales:</h4>
                <ul>
            `;
            studentMateriaGrades.parciales.forEach((grade, index) => {
                detailsHTML += `<li>Parcial ${index + 1}: ${grade !== null ? grade : 'N/A'}</li>`;
            });
            detailsHTML += `</ul>`;
            const overallGrade = calculateOverallGrade(student, materiaName);
            if (overallGrade !== null) {
                detailsHTML += `<p><strong>Calificación General:</strong> ${overallGrade.toFixed(2)}</p>`;
            } else {
                detailsHTML += `<p><strong>Calificación General:</strong> N/A (faltan notas)</p>`;
            }
            gradeDetailsContent.innerHTML = detailsHTML;
            studentGradeDetailModal.style.display = 'block';
        }
        function renderAdminPanelButtons() {
            adminPanelContent.innerHTML = ''; 
            const buttonsConfig = [
                { text: 'Gestionar Noticias y Eventos', icon: 'fas fa-bullhorn', target: '#manageNewsEventsModal' },
                { text: 'Gestionar Biblioteca', icon: 'fas fa-book-reader', target: '#manageLibraryModal' },
                { text: 'Crear Materia', icon: 'fas fa-chalkboard', target: '#createMateriaModal' },
                { text: 'Registrar Alumno', icon: 'fas fa-user-plus', target: '#registerStudentModal' },
                { text: 'Lista de Materias y Calificaciones', icon: 'fas fa-list-alt', target: '#listMateriasModal' }
            ];
            buttonsConfig.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'admin-button';
                button.innerHTML = `<span class="button-icon"><i class="${btn.icon}"></i></span> ${btn.text}`;
                button.addEventListener('click', () => {
                    const modal = document.querySelector(btn.target);
                    if (modal) {
                        modal.style.display = 'block';
                        if (btn.target === '#manageNewsEventsModal') {
                            renderAdminNewsEventsTable();
                            newsEventForm.reset();
                            newsEventIdInput.value = '';
                        } else if (btn.target === '#manageLibraryModal') {
                            renderAdminLibraryItemsTable();
                            libraryItemForm.reset();
                            libraryItemIdInput.value = '';
                            const nextCode = allLibraryItems.length + 1;
                            libraryItemCodeDisplay.value = nextCode;
                        } else if (btn.target === '#createMateriaModal') {
                            renderAdminMateriasTable();
                            createMateriaForm.reset();
                            materiaIdInput.value = '';
                        } else if (btn.target === '#registerStudentModal') {
                            populateStudentMateriasCheckboxes();
                            renderAdminStudentsTable();
                            registerStudentForm.reset();
                            studentIdInput.value = '';
                        } else if (btn.target === '#listMateriasModal') {
                            renderMateriasListButtons();
                        }
                    }
                });
                adminPanelContent.appendChild(button);
            });
            const logoutButton = document.createElement('button');
            logoutButton.className = 'admin-button logout-button';
            logoutButton.id = 'adminLogoutButton';
            logoutButton.innerHTML = `<span class="button-icon"><i class="fas fa-sign-out-alt"></i></span> Cerrar Sesión Admin`;
            logoutButton.addEventListener('click', () => {
                adminPanelContent.innerHTML = '';
                adminPanelContent.style.display = 'none';
                loginCard.style.display = 'block';
                portalIntroText.style.display = 'block';
                portalTitle.textContent = 'Portal de Acceso';
                userIsLoggedIn = false;
                updateLibraryTabContentVisibility();
            });
            adminPanelContent.appendChild(logoutButton);
        }
        document.addEventListener('DOMContentLoaded', () => {
            navItems = document.querySelectorAll('.nav-item');
            tabContents = document.querySelectorAll('.tab-content');
            actionButtons = document.querySelectorAll('.action-button');
            modals = document.querySelectorAll('.modal');
            closeButtons = document.querySelectorAll('.close-button');
            portalTitle = document.getElementById('portal-title');
            portalIntroText = document.getElementById('portal-intro-text');
            loginCard = document.getElementById('login-card');
            togglePassword = document.getElementById('togglePassword');
            passwordInput = document.getElementById('password');
            loginForm = document.getElementById('login-form');
            adminPanelContent = document.getElementById('admin-panel-content');
            studentPortalContent = document.getElementById('student-portal-content');
            studentPortalName = document.getElementById('student-portal-name');
            studentMateriasGrades = document.getElementById('student-materias-grades');
            studentLogoutButton = document.getElementById('studentLogoutButton');
            manageNewsEventsModal = document.getElementById('manageNewsEventsModal');
            newsEventForm = document.getElementById('news-event-form');
            newsEventIdInput = document.getElementById('news-event-id');
            newsEventTypeInput = document.getElementById('news-event-type');
            newsEventTitleInput = document.getElementById('news-event-title-input');
            newsEventHeadingInput = document.getElementById('news-event-heading-input');
            newsEventsAdminTbody = document.getElementById('news-events-admin-tbody');
            newsEventsDisplay = document.getElementById('news-events-display');
            manageLibraryModal = document.getElementById('manageLibraryModal');
            libraryItemForm = document.getElementById('library-item-form');
            libraryItemIdInput = document.getElementById('library-item-id');
            libraryItemCodeDisplay = document.getElementById('library-item-code-display');
            libraryItemTitleInput = document.getElementById('library-item-title');
            libraryItemTypeSelect = document.getElementById('library-item-type');
            libraryItemLinkInput = document.getElementById('library-item-link');
            libraryItemDescriptionInput = document.getElementById('library-item-description');
            libraryItemsAdminTbody = document.getElementById('library-items-admin-tbody');
            createMateriaModal = document.getElementById('createMateriaModal');
            createMateriaForm = document.getElementById('create-materia-form');
            materiaIdInput = document.getElementById('materia-id');
            materiaNameInput = document.getElementById('materia-name');
            ponderacionAsistenciaInput = document.getElementById('ponderacion-asistencia');
            ponderacionPracticasInput = document.getElementById('ponderacion-practicas');
            ponderacionParcialesInput = document.getElementById('ponderacion-parciales');
            materiasAdminTbody = document.getElementById('materias-admin-tbody');
            registerStudentModal = document.getElementById('registerStudentModal');
            registerStudentForm = document.getElementById('register-student-form');
            studentIdInput = document.getElementById('student-id');
            studentPaternoInput = document.getElementById('student-paterno');
            studentMaternoInput = document.getElementById('student-materno');
            studentNombresInput = document.getElementById('student-nombres');
            studentCelularInput = document.getElementById('student-celular');
            studentMateriasCheckboxGroup = document.getElementById('student-materias-checkbox-group');
            studentsAdminTbody = document.getElementById('students-admin-tbody');
            listMateriasModal = document.getElementById('listMateriasModal');
            materiasListButtons = document.getElementById('materias-list-buttons');
            studentGradesModal = document.getElementById('studentGradesModal');
            studentGradesTitle = document.getElementById('student-grades-title');
            currentStudentNameGradesModal = document.getElementById('current-student-name-grades-modal');
            currentMateriaNameGradesModal = document.getElementById('current-materia-name-grades-modal');
            gradeForm = document.getElementById('grade-form');
            gradeStudentIdInput = document.getElementById('grade-student-id');
            gradeMateriaNameInput = document.getElementById('grade-materia-name');
            gradeAsistenciaInput = document.getElementById('grade-asistencia');
            practicasInputsDiv = document.getElementById('practicas-inputs');
            parcialesInputsDiv = document.getElementById('parciales-inputs');
            studentGradeDetailModal = document.getElementById('studentGradeDetailModal');
            detailStudentName = document.getElementById('detail-student-name');
            detailMateriaName = document.getElementById('detail-materia-name');
            gradeDetailsContent = document.getElementById('grade-details-content');
            practicasSearchInput = document.getElementById('practicas-search');
            librosSearchInput = document.getElementById('libros-search');
            videosSearchInput = document.getElementById('videos-search');
            softwareSearchInput = document.getElementById('software-search');
            libraryAccessRequiredDiv = document.getElementById('library-access-required');
            libraryContentDiv = document.getElementById('library-content');
            updateLibraryTabContentVisibility();
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    navItems.forEach(nav => nav.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    item.classList.add('active');
                    const tabId = item.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            actionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const modalTargetId = button.getAttribute('data-modal-target');
                    const modal = document.querySelector(modalTargetId);
                    if (modal) {
                        modal.style.display = 'block';
                        if (modalTargetId === '#practicasModal') {
                            practicasSearchInput.value = '';
                            filterLibraryItems('practica', '');
                        } else if (modalTargetId === '#librosModal') {
                            librosSearchInput.value = '';
                            filterLibraryItems('libro', '');
                        } else if (modalTargetId === '#videosModal') {
                            videosSearchInput.value = '';
                            filterLibraryItems('video', '');
                        } else if (modalTargetId === '#softwareModal') {
                            softwareSearchInput.value = '';
                            filterLibraryItems('software', '');
                        }
                    }
                });
            });
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const modal = button.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                        const form = modal.querySelector('form');
                        if (form) form.reset();
                        const hiddenId = modal.querySelector('input[type="hidden"]');
                        if(hiddenId) hiddenId.value = '';
                    }
                });
            });
            window.addEventListener('click', (event) => {
                modals.forEach(modal => {
                    if (event.target == modal && modal.id !== 'messageBoxModal') {
                        modal.style.display = 'none';
                        const form = modal.querySelector('form');
                        if (form) form.reset();
                        const hiddenId = modal.querySelector('input[type="hidden"]');
                        if(hiddenId) hiddenId.value = '';
                    }
                });
            });
            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function () {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    this.querySelector('i').classList.toggle('fa-eye');
                    this.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const adminUsername = 'douglas';
                    const adminPassword = 'd5720';
                    if (username.toLowerCase() === adminUsername.toLowerCase() && password.toLowerCase() === adminPassword.toLowerCase()) {
                        userIsLoggedIn = true;
                        loginCard.style.display = 'none';
                        portalIntroText.style.display = 'none';
                        portalTitle.textContent = 'Panel de Administración';
                        adminPanelContent.style.display = 'flex';
                        studentPortalContent.style.display = 'none';
                        renderAdminPanelButtons();
                        loginForm.reset();
                        updateLibraryTabContentVisibility();
                    } else {
                        try {
                            const studentQuery = query(studentsCollection, where("nombres", "==", username));
                            const studentSnapshot = await getDocs(studentQuery);
                            let studentFound = false;
                            if (!studentSnapshot.empty) {
                                studentSnapshot.forEach(studentDoc => {
                                    const studentData = studentDoc.data();
                                    if (studentData.celular === password) {
                                        currentLoggedInStudent = { id: studentDoc.id, ...studentData };
                                        userIsLoggedIn = true;
                                        loginCard.style.display = 'none';
                                        portalIntroText.style.display = 'none';
                                        adminPanelContent.style.display = 'none';
                                        portalTitle.textContent = 'Portal del Estudiante';
                                        studentPortalContent.style.display = 'flex';
                                        studentPortalName.textContent = `${currentLoggedInStudent.nombres} ${currentLoggedInStudent.paterno}`;
                                        renderStudentPortal();
                                        loginForm.reset();
                                        updateLibraryTabContentVisibility();
                                        studentFound = true;
                                    }
                                });
                            }
                            if (!studentFound) {
                                showMessageBox('Error de Inicio de Sesión', 'Usuario o contraseña incorrectos. Por favor, inténtalo de nuevo.');
                            }
                        } catch (error) {
                            console.error("Error durante el inicio de sesión del estudiante:", error);
                            showMessageBox('Error de Inicio de Sesión', 'Ocurrió un error al intentar iniciar sesión. Por favor, inténtalo de nuevo.');
                        }
                    }
                });
            }
            studentLogoutButton.addEventListener('click', () => {
                currentLoggedInStudent = null;
                userIsLoggedIn = false;
                studentPortalContent.style.display = 'none';
                loginCard.style.display = 'block';
                portalIntroText.style.display = 'block';
                portalTitle.textContent = 'Portal de Acceso';
                updateLibraryTabContentVisibility();
            });
            function updateLibraryTabContentVisibility() {
                if (userIsLoggedIn) {
                    libraryContentDiv.style.display = 'block';
                    libraryAccessRequiredDiv.style.display = 'none';
                } else {
                    libraryContentDiv.style.display = 'none';
                    libraryAccessRequiredDiv.style.display = 'block';
                }
            }
            newsEventForm.addEventListener('submit', handleNewsEventFormSubmit);
            libraryItemForm.addEventListener('submit', handleLibraryItemFormSubmit);
            createMateriaForm.addEventListener('submit', handleCreateMateriaFormSubmit);
            registerStudentForm.addEventListener('submit', handleRegisterStudentFormSubmit);
            gradeForm.addEventListener('submit', handleGradeFormSubmit);
            setupFirebaseAndAuth();
        });
    </script>
</body>
</html>
