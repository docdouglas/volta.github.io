<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novell App Móvil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Importación de fuentes y definición de variables */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap');

        :root {
            --primary-color: #4a69bd;
            --secondary-color: #6a89cc;
            --background-color: #f5f6fa;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 16px;
            --dark-nav-bg: #2c3e50;
            --nav-inactive-color: #ecf0f1;
            --nav-active-color: #FFD700;
            --underline-color: #e74c3c;
            --delete-color: #e74c3c;
            --edit-color: #f39c12;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        /* Estilos generales y optimización para móvil */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100vw; /* Asegura que ocupe el 100% del ancho del viewport */
            height: 100vh; /* Asegura que ocupe el 100% de la altura del viewport */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Oculta cualquier desbordamiento global */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .content {
            flex-grow: 1;
            padding: 24px;
            height: calc(100vh - 60px); /* Altura explícita para dejar espacio a la barra de navegación */
            overflow-y: auto; /* Permite el desplazamiento vertical dentro del área de contenido */
            position: relative;
        }

        /* Contenedor principal de pestañas para el deslizamiento */
        .tabs-container {
            display: flex;
            width: 300%;
            height: 100%;
            transition: transform 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
        }

        .tab-content {
            width: 33.333%;
            height: 100%;
            padding: 30px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            flex-shrink: 0;
            overflow-y: auto;
            overflow-x: hidden; /* Evita el desplazamiento horizontal dentro de cada pestaña */
        }

        /* Estilo para los títulos de todas las secciones con iconos */
        .tab-content h1, .login-container h2 {
            color: var(--primary-color);
            margin-bottom: 16px;
            font-size: 24px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 8px;
            border-bottom: 3px solid var(--underline-color);
        }
        
        .tab-content h1 i, .login-container h2 i {
            margin-right: 10px;
        }

        .tab-content p {
            text-align: center;
            color: #666;
        }

        /* Encabezado con imagen más pequeña */
        .header-image {
            width: 100%;
            margin-bottom: 30px;
            text-align: center;
        }

        .header-image img {
            max-width: 180px;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        /* Barra de navegación inferior con fondo oscuro */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background: var(--dark-nav-bg);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 0;
            flex: 1;
            color: var(--nav-inactive-color);
            text-decoration: none;
            transition: color 0.3s ease, transform 0.3s ease;
            font-size: 13px;
        }

        .nav-item i {
            font-size: 1.6rem;
        }

        .nav-item span {
            display: none;
            margin-top: 4px;
            transition: opacity 0.3s ease;
            opacity: 1;
        }

        .nav-item.active {
            color: var(--nav-active-color);
            transform: translateY(-8px);
        }

        .nav-item.active span {
            display: block;
            opacity: 1;
        }

        /* Estilo del formulario de inicio de sesión minimalista */
        .login-container {
            width: 100%;
            padding: 24px;
            text-align: center;
        }

        .login-container h2 {
            margin-bottom: 24px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .input-group {
            position: relative;
            margin-bottom: 30px;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 15px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: transparent;
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            border-color: var(--primary-color);
        }

        .input-group label {
            position: absolute;
            top: 15px;
            left: 12px;
            color: #888;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .input-group textarea + label {
            top: 15px; /* Ajusta la posición de la etiqueta del textarea */
            left: 12px;
        }
        
        .input-group textarea:focus + label,
        .input-group textarea:valid + label {
            top: -10px;
            left: 12px;
            font-size: 12px;
            color: var(--primary-color);
            background-color: var(--card-bg);
            padding: 0 5px;
        }
        
        .input-group input:focus + label,
        .input-group input:valid + label,
        .input-group select:focus + label,
        .input-group select:valid + label {
            top: -10px;
            left: 12px;
            font-size: 12px;
            color: var(--primary-color);
            background-color: var(--card-bg);
            padding: 0 5px;
        }

        /* Ocultar/mostrar contraseña */
        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
            font-size: 1.2rem;
            transition: color 0.3s ease;
        }

        .toggle-password:hover {
            color: var(--primary-color);
        }

        /* Botón de acceso con degradado */
        .login-btn, .logout-btn, .action-btn {
            width: 100%;
            padding: 14px;
            background-image: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .login-btn:active, .logout-btn:active, .action-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Contenedor y botones de administrador */
        .admin-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-top: 20px;
        }

        .admin-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .admin-btn:hover {
            background-color: var(--secondary-color);
        }

        .create-materia-btn, .create-news-btn, .create-student-btn, .create-library-btn {
            background-color: #2ecc71;
        }
        
        .create-news-btn { background-color: #3498db; }
        .create-student-btn { background-color: #9b59b6; }
        .create-library-btn { background-color: #1abc9c; }

        /* Estilos para listas de gestión y tablas */
        .list-container {
            margin-top: 25px;
            text-align: left;
        }
        .list {
            list-style: none;
            padding: 0;
        }
        .list li {
            background: #f1f2f6;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-name {
            font-weight: 500;
            flex-grow: 1;
        }
        .list-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 10px;
            transition: color 0.2s ease;
        }
        .list-actions .edit-btn {
            color: var(--edit-color);
        }
        .list-actions .delete-btn {
            color: var(--delete-color);
        }
        .list-title {
            text-align: center;
            margin-bottom: 15px;
        }

        /* Tablas */
        .responsive-table {
            width: 100%;
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table th {
            background-color: var(--primary-color);
            color: #fff;
        }
        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        /* NUEVOS ESTILOS PARA LA BIBLIOTECA PÚBLICA */
        #public-library-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .resource-group {
            background: #f1f2f6;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .resource-group-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
        }
        .resource-group table {
            width: 100%;
            border-collapse: collapse;
        }
        .resource-group th, .resource-group td {
            padding: 10px 5px;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid #e0e0e0;
        }
        .resource-group th {
            font-weight: 500;
            color: #555;
            text-transform: uppercase;
        }
        .resource-group tr:last-child td {
            border-bottom: none;
        }

        /* Estilos del modal flotante (general) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: var(--border-radius);
            position: relative;
            animation: fadeIn 0.5s;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        
        #news-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f0fe;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #news-container h3 {
            color: var(--primary-color);
            margin-bottom: 5px;
            text-align: center;
        }
        #news-container p {
            font-size: 14px;
            color: #555;
            text-align: justify;
        }

        /* Estilos para el portal del alumno */
        .student-portal-container {
            display: none;
            padding: 24px;
            text-align: center;
        }
        .student-portal-container h2 {
            margin-bottom: 24px;
            color: var(--primary-color);
            font-weight: 500;
            border-bottom: 3px solid var(--underline-color);
        }
        .student-info, .student-grades, .student-attendance, .student-practices {
            background-color: #f1f2f6;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: left;
        }
        .student-info h3, .student-grades h3, .student-attendance h3, .student-practices h3 {
            color: var(--text-color);
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .student-info p, .student-grades p, .student-attendance p, .student-practices p {
            margin-bottom: 8px;
            font-size: 14px;
        }
        .grade-item, .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding: 8px 0;
        }
        .grade-item:last-child, .attendance-item:last-child {
            border-bottom: none;
        }
        .grade-label {
            font-weight: bold;
        }
        .grade-value {
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .final-grade {
            font-size: 20px;
            font-weight: bold;
            color: var(--delete-color);
            margin-top: 15px;
        }
        
        /* Estilos del modal de gestión de calificaciones */
        .grades-management-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .grades-management-container .action-btn {
            width: 100%;
        }

        .grading-tab-content {
            padding: 15px; 
            background: #f1f2f6;
            border-radius: var(--border-radius);
            flex-grow: 1;
            overflow-y: auto;
        }
        .grading-tab-content h3 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .grading-tab-content p {
            text-align: center;
            color: #555;
            margin-bottom: 15px;
        }
        .grading-tab-content .input-group {
            margin-bottom: 15px;
        }
        .save-grades-btn {
            margin-top: 20px;
            width: 100%;
        }

        #grades-message {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            color: #fff;
            display: none;
        }

        #grades-message.success {
            background-color: var(--success-color);
        }
        #grades-message.error {
            background-color: var(--error-color);
        }
        
        /* Estilos del modal de confirmación y alerta personalizados */
        .confirmation-modal .modal-content, .message-modal .modal-content {
            max-width: 350px;
            text-align: center;
        }
        .confirmation-modal .modal-content h3, .message-modal .modal-content h3 {
            margin-bottom: 15px;
        }
        .confirmation-modal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .confirmation-modal .modal-buttons .action-btn {
            width: 100px;
            padding: 10px;
        }
        .confirmation-modal .cancel-btn {
            background-color: #ccc;
            color: var(--text-color);
            box-shadow: none;
        }
        .confirmation-modal .cancel-btn:active {
            transform: translateY(2px);
        }
        
        /* Estilos para el multi-select */
        .multi-select-container {
            position: relative;
            margin-bottom: 30px;
            text-align: left;
        }

        .multi-select-container .selected-items-display {
            padding: 15px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            min-height: 50px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 5px;
        }

        .multi-select-container .selected-item-tag {
            background: var(--primary-color);
            color: #fff;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
        }

        .multi-select-container .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .multi-select-container .dropdown-content label {
            display: block;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .multi-select-container .dropdown-content label:hover {
            background-color: #f5f5f5;
        }

        .multi-select-container .dropdown-content input[type="checkbox"] {
            margin-right: 10px;
        }

    </style>
</head>
<body>

    <main class="content">
        <div class="tabs-container">
            <section id="inicio" class="tab-content">
                <header class="header-image">
                    <img src="novell.png" alt="Logo de Novell">
                </header>
                <h1><i class="fa-solid fa-house-user"></i>Bienvenido</h1>
                <p>Volta: La página principal del Instituto Novell, que refleja nuestro compromiso con la excelencia en electrónica. Aquí encontrarás una interfaz que te permitirá descargar y estudiar material de libros, software y videos.</p>
                <div id="news-container"></div>
            </section>

            <!-- SECCIÓN DE BIBLIOTECA PÚBLICA MODIFICADA PARA AGRUPAR POR TIPO -->
            <section id="biblioteca" class="tab-content">
                <h1><i class="fa-solid fa-book-open-reader"></i>Biblioteca</h1>
                <p>Aquí encontrarás una gran colección de recursos disponibles para ti.</p>
                <div id="public-library-container">
                    <!-- El contenido de la biblioteca pública se generará aquí dinámicamente por tipo -->
                </div>
            </section>

            <section id="portal" class="tab-content">
                <div id="login-form-container">
                    <div class="login-container">
                        <h2><i class="fa-solid fa-right-to-bracket"></i>Accede a tu portal</h2>
                        <form id="login-form">
                            <div class="input-group">
                                <input type="text" id="username" required>
                                <label for="username">Usuario</label>
                            </div>
                            <div class="input-group password-group">
                                <input type="password" id="password" required>
                                <label for="password">Contraseña</label>
                                <span class="toggle-password" id="togglePassword">
                                    <i class="fa-solid fa-eye-slash"></i>
                                </span>
                            </div>
                            <button type="submit" class="login-btn">Entrar</button>
                            <p id="error-message" style="color: var(--error-color); margin-top: 15px; display: none;">Usuario o contraseña incorrectos.</p>
                        </form>
                    </div>
                </div>

                <div id="admin-panel" style="display: none;">
                    <div class="login-container">
                        <h2><i class="fa-solid fa-user-gear"></i>Panel de Administrador</h2>
                        <div class="admin-buttons-container">
                            <button class="admin-btn" data-modal="news-management-modal">Noticias/Eventos</button>
                            <button class="admin-btn" data-modal="students-management-modal">Registro</button>
                            <button class="admin-btn" data-modal="calificaciones-management-modal">Calificaciones</button>
                            <button class="admin-btn" data-modal="materia-management-modal">Crear Materia</button>
                            <button class="admin-btn" data-modal="biblioteca-management-modal">Biblioteca</button>
                        </div>

                        <button id="logout-btn" class="logout-btn" style="margin-top: 25px;">Cerrar sesión</button>
                    </div>
                </div>

                <div id="student-portal" class="student-portal-container">
                    <h2><i class="fa-solid fa-user-circle"></i>Portal del Alumno</h2>
                    
                    <div class="student-info">
                        <h3 id="student-name"></h3>
                        <p><strong>Cursos:</strong> <span id="student-materias"></span></p>
                    </div>

                    <!-- Nuevo selector de materia para el alumno -->
                    <div class="input-group" style="margin-top: 20px;">
                        <select id="student-materia-select"></select>
                    </div>
                    
                    <div class="student-grades">
                        <h3><i class="fa-solid fa-graduation-cap"></i>Calificaciones</h3>
                        <div id="grades-list"></div>
                        <p class="final-grade">Nota final: <span id="final-grade-value">N/A</span></p>
                    </div>

                    <div class="student-attendance">
                        <h3><i class="fa-solid fa-clipboard-user"></i>Asistencia</h3>
                        <div id="attendance-list"></div>
                    </div>

                    <div class="student-practices">
                        <h3><i class="fa-solid fa-pencil"></i>Prácticas</h3>
                        <div id="practices-list"></div>
                    </div>
                    
                    <button id="student-logout-btn" class="logout-btn" style="margin-top: 25px;">Cerrar sesión</button>
                </div>
            </section>
        </div>
    </main>
    
    <div id="materia-management-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="materia-management" class="list-container">
                <h3 class="list-title">Materias creadas</h3>
                <button class="action-btn create-materia-btn" id="create-materia-btn-in-panel" style="margin-bottom: 15px;">Crear Materia</button>
                <ul id="materia-list" class="list"></ul>
            </div>
        </div>
    </div>
    
    <div id="news-management-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="news-management" class="list-container">
                <h3 class="list-title">Noticias/Eventos</h3>
                <button class="action-btn create-news-btn" id="create-news-btn-in-panel" style="margin-bottom: 15px;">Crear Noticia</button>
                <ul id="news-list" class="list"></ul>
            </div>
        </div>
    </div>
    
    <div id="students-management-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="students-management" class="list-container">
                <h3 class="list-title">Alumnos Registrados</h3>
                <button class="action-btn create-student-btn" id="create-student-btn-in-panel" style="margin-bottom: 15px;">Registrar Alumno</button>
                <ul id="student-list" class="list"></ul>
            </div>
        </div>
    </div>
    
    <div id="calificaciones-management-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="calificaciones-management" class="list-container">
                <h3 class="list-title">Gestión de Calificaciones</h3>
                <ul id="calificaciones-alumnos-list" class="list"></ul>
            </div>
        </div>
    </div>

    <div id="biblioteca-management-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="biblioteca-management" class="list-container">
                <h3 class="list-title">Gestión de Biblioteca</h3>
                <button class="action-btn create-library-btn" id="create-library-resource-btn-in-panel" style="margin-bottom: 15px;">Crear Recurso</button>
                <div class="responsive-table">
                    <table id="biblioteca-admin-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Título</th>
                                <th>Tipo</th>
                                <th>Link</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NUEVO: Modal principal para gestionar calificaciones por alumno -->
    <div id="grades-main-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fa-solid fa-graduation-cap"></i>Gestionar Calificaciones</h2>
            <h3 id="grades-main-student-name" style="text-align: center; margin-top: 10px;"></h3>
            
            <!-- Nuevo selector de materia para el administrador -->
            <div class="input-group" style="margin-top: 20px;">
                <select id="grades-materia-select">
                    <option value="">Seleccione una materia</option>
                </select>
                <label for="grades-materia-select">Materia</label>
            </div>
            
            <div class="grades-management-container" id="grades-options" style="display: none;">
                <button class="action-btn" id="open-asistencia-btn">Asistencia</button>
                <button class="action-btn" id="open-practicas-btn">Prácticas</button>
                <button class="action-btn" id="open-parciales-btn">Parciales</button>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal independiente para Asistencia -->
    <div id="asistencia-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fa-solid fa-clipboard-user"></i>Gestión de Asistencia</h2>
            <h4 id="asistencia-student-name" style="text-align: center; margin-bottom: 10px;"></h4>
            <p id="asistencia-ponderacion-info" style="text-align: center; font-style: italic;"></p>
            <div class="grading-tab-content">
                <div class="input-group">
                    <input type="number" id="asistencia-input" min="0" max="100" required>
                    <label for="asistencia-input">Porcentaje de asistencia</label>
                </div>
                <p id="asistencia-message" class="success"></p>
                <button class="action-btn save-grades-btn" id="save-asistencia-btn">Guardar Asistencia</button>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal independiente para Prácticas -->
    <div id="practicas-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fa-solid fa-pencil"></i>Gestión de Prácticas</h2>
            <h4 id="practicas-student-name" style="text-align: center; margin-bottom: 10px;"></h4>
            <p id="practicas-ponderacion-info" style="text-align: center; font-style: italic;"></p>
            <div class="grading-tab-content">
                <div class="input-group">
                    <input type="number" id="practica1-input" min="0" max="100" required>
                    <label for="practica1-input">Práctica 1</label>
                </div>
                <div class="input-group">
                    <input type="number" id="practica2-input" min="0" max="100" required>
                    <label for="practica2-input">Práctica 2</label>
                </div>
                <div class="input-group">
                    <input type="number" id="practica3-input" min="0" max="100" required>
                    <label for="practica3-input">Práctica 3</label>
                </div>
                <div class="input-group">
                    <input type="number" id="practica4-input" min="0" max="100" required>
                    <label for="practica4-input">Práctica 4</label>
                </div>
                <div class="input-group">
                    <input type="number" id="practica5-input" min="0" max="100" required>
                    <label for="practica5-input">Práctica 5</label>
                </div>
                <div class="input-group">
                    <input type="number" id="practica6-input" min="0" max="100" required>
                    <label for="practica6-input">Práctica 6</label>
                </div>
                <p id="practicas-message" class="success"></p>
                <button class="action-btn save-grades-btn" id="save-practicas-btn">Guardar Prácticas</button>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal independiente para Parciales -->
    <div id="parciales-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fa-solid fa-file-alt"></i>Gestión de Parciales</h2>
            <h4 id="parciales-student-name" style="text-align: center; margin-bottom: 10px;"></h4>
            <p id="parciales-ponderacion-info" style="text-align: center; font-style: italic;"></p>
            <div class="grading-tab-content">
                <div class="input-group">
                    <input type="number" id="parcial1-input" min="0" max="100" required>
                    <label for="parcial1-input">Parcial 1</label>
                </div>
                <div class="input-group">
                    <input type="number" id="parcial2-input" min="0" max="100" required>
                    <label for="parcial2-input">Parcial 2</label>
                </div>
                <p id="parciales-message" class="success"></p>
                <button class="action-btn save-grades-btn" id="save-parciales-btn">Guardar Parciales</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmación y alerta personalizados -->
    <div id="confirmation-modal" class="modal confirmation-modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="confirmation-message"></h3>
            <div class="modal-buttons">
                <button id="confirm-yes-btn" class="action-btn">Sí</button>
                <button id="confirm-no-btn" class="action-btn cancel-btn">No</button>
            </div>
        </div>
    </div>
    
    <div id="message-modal" class="modal message-modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="message-text"></h3>
            <div class="modal-buttons">
                <button id="message-ok-btn" class="action-btn">Aceptar</button>
            </div>
        </div>
    </div>
    
    <!-- MODALES FALTANTES -->
    
    <!-- Modal para crear/editar Materia -->
    <div id="materia-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fa-solid fa-pen-to-square"></i>Crear Materia</h2>
            <form id="materia-form">
                <div class="input-group">
                    <input type="text" id="materia-name-input" required>
                    <label for="materia-name-input">Nombre de la materia</label>
                </div>
                <h3>Ponderación de Notas (%)</h3>
                <div class="input-group">
                    <input type="number" id="asistencia-ponderacion-input" min="0" max="100" required>
                    <label for="asistencia-ponderacion-input">Asistencia</label>
                </div>
                <div class="input-group">
                    <input type="number" id="practicas-ponderacion-input" min="0" max="100" required>
                    <label for="practicas-ponderacion-input">Prácticas</label>
                </div>
                <div class="input-group">
                    <input type="number" id="parciales-ponderacion-input" min="0" max="100" required>
                    <label for="parciales-ponderacion-input">Parciales</label>
                </div>
                <button type="submit" class="action-btn">Guardar Materia</button>
            </form>
        </div>
    </div>

    <!-- Modal para crear/editar Noticias -->
    <div id="news-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fa-solid fa-newspaper"></i>Crear Noticia/Evento</h2>
            <form id="news-form">
                <div class="input-group">
                    <input type="text" id="news-title-input" required>
                    <label for="news-title-input">Título</label>
                </div>
                <div class="input-group">
                    <textarea id="news-body-input" rows="5" required></textarea>
                    <label for="news-body-input">Cuerpo</label>
                </div>
                <button type="submit" class="action-btn">Guardar Noticia</button>
            </form>
        </div>
    </div>

    <!-- Modal para registrar/modificar alumnos -->
    <div id="registration-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="registration-modal-title"><i class="fa-solid fa-user-plus"></i>Registrar Alumno</h2>
            <form id="registration-form">
                <div class="input-group">
                    <input type="text" id="paternal-lastname" required>
                    <label for="paternal-lastname">Apellido Paterno</label>
                </div>
                <div class="input-group">
                    <input type="text" id="maternal-lastname" required>
                    <label for="maternal-lastname">Apellido Materno</label>
                </div>
                <div class="input-group">
                    <input type="text" id="names" required>
                    <label for="names">Nombres</label>
                </div>
                <div class="input-group">
                    <input type="text" id="phone-number" required>
                    <label for="phone-number">Número de Teléfono</label>
                </div>
                
                <!-- Multi-select para materias -->
                <div class="multi-select-container">
                    <div class="selected-items-display">
                        <span id="materias-display-label">Seleccione materias</span>
                    </div>
                    <div id="materias-dropdown" class="dropdown-content">
                        <!-- Las opciones se poblarán dinámicamente -->
                    </div>
                </div>
                
                <button type="submit" class="action-btn">Guardar Alumno</button>
            </form>
        </div>
    </div>

    <!-- Modal para crear/editar recursos de biblioteca -->
    <div id="biblioteca-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fa-solid fa-folder-plus"></i>Crear Recurso</h2>
            <form id="biblioteca-form">
                <div class="input-group">
                    <input type="text" id="codigo-select" required>
                    <label for="codigo-select">Código</label>
                </div>
                <div class="input-group">
                    <input type="text" id="recurso-titulo" required>
                    <label for="recurso-titulo">Título del Recurso</label>
                </div>
                <div class="input-group">
                    <select id="tipo-select" required>
                        <option value="">Seleccione un tipo</option>
                        <option value="Libro">Libro</option>
                        <option value="Artículo">Artículo</option>
                        <option value="Tesis">Tesis</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <label for="tipo-select">Tipo</label>
                </div>
                <div class="input-group">
                    <input type="url" id="recurso-link" required>
                    <label for="recurso-link">Enlace del Recurso</label>
                </div>
                <button type="submit" class="action-btn">Guardar Recurso</button>
            </form>
        </div>
    </div>


    <nav class="navbar">
        <a href="#inicio" class="nav-item active">
            <i class="fa-solid fa-house"></i>
            <span>Inicio</span>
        </a>
        <a href="#biblioteca" class="nav-item">
            <i class="fa-solid fa-book"></i>
            <span>Biblioteca</span>
        </a>
        <a href="#portal" class="nav-item">
            <i class="fa-solid fa-user-circle"></i>
            <span>Portal</span>
        </a>
    </nav>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCoeIyKkUbtKLzpr0-FO9vkt9SqsMuQl_k",
            authDomain: "volta-77f5a.firebaseapp.com",
            databaseURL: "https://volta-77f5a-default-rtdb.firebaseio.com",
            projectId: "volta-77f5a",
            storageBucket: "volta-77f5a.firebasestorage.app",
            messagingSenderId: "209382996934",
            appId: "1:209382996934:web:f85f1eccff138ee26a10c7"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dbMaterias = database.ref('materias');
        const dbNoticias = database.ref('noticias');
        const dbAlumnos = database.ref('alumnos');
        const dbBiblioteca = database.ref('biblioteca');

        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            const tabsContainer = document.querySelector('.tabs-container');
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const loginForm = document.getElementById('login-form');
            const loginFormContainer = document.getElementById('login-form-container');
            const adminPanel = document.getElementById('admin-panel');
            const studentPortal = document.getElementById('student-portal');
            const logoutBtn = document.getElementById('logout-btn');
            const studentLogoutBtn = document.getElementById('student-logout-btn');
            const errorMessage = document.getElementById('error-message');
            
            // Botones del panel de admin
            const adminPanelButtons = document.querySelectorAll('.admin-btn');
            
            // Botones de crear en cada panel
            const createMateriaBtnInPanel = document.getElementById('create-materia-btn-in-panel');
            const createNewsBtnInPanel = document.getElementById('create-news-btn-in-panel');
            const createStudentBtnInPanel = document.getElementById('create-student-btn-in-panel');
            const createLibraryResourceBtnInPanel = document.getElementById('create-library-resource-btn-in-panel');
            
            // Contenedores de gestión
            const materiaManagement = document.getElementById('materia-management');
            const newsManagement = document.getElementById('news-management');
            const studentsManagement = document.getElementById('students-management');
            const calificacionesManagement = document.getElementById('calificaciones-management');
            const bibliotecaManagement = document.getElementById('biblioteca-management');

            // Listas y tablas
            const materiaList = document.getElementById('materia-list');
            const newsList = document.getElementById('news-list');
            const studentList = document.getElementById('student-list');
            const calificacionesAlumnosList = document.getElementById('calificaciones-alumnos-list');
            const bibliotecaAdminTableBody = document.querySelector('#biblioteca-admin-table tbody');
            const publicLibraryContainer = document.getElementById('public-library-container');

            // Modals
            const registrationModal = document.getElementById('registration-modal');
            const bibliotecaModal = document.getElementById('biblioteca-modal');
            const materiaModal = document.getElementById('materia-modal');
            const newsModal = document.getElementById('news-modal');
            const allModals = document.querySelectorAll('.modal');
            const confirmationModal = document.getElementById('confirmation-modal');
            const messageModal = document.getElementById('message-modal');

            // Nuevos modales para gestión de calificaciones
            const gradesMainModal = document.getElementById('grades-main-modal');
            const asistenciaModal = document.getElementById('asistencia-modal');
            const practicasModal = document.getElementById('practicas-modal');
            const parcialesModal = document.getElementById('parciales-modal');
            
            // Formularios
            const registrationForm = document.getElementById('registration-form');
            const bibliotecaForm = document.getElementById('biblioteca-form');
            const materiaForm = document.getElementById('materia-form');
            const newsForm = document.getElementById('news-form');

            // Campos del formulario
            const materiaNameInput = document.getElementById('materia-name-input');
            const asistenciaPonderacionInput = document.getElementById('asistencia-ponderacion-input');
            const practicasPonderacionInput = document.getElementById('practicas-ponderacion-input');
            const parcialesPonderacionInput = document.getElementById('parciales-ponderacion-input');
            const newsTitleInput = document.getElementById('news-title-input');
            const newsBodyInput = document.getElementById('news-body-input');
            const materiasDropdown = document.getElementById('materias-dropdown');
            
            // Nuevos elementos para la noticia en la pestaña de inicio
            const newsContainer = document.getElementById('news-container');
            
            // Campos de alumno
            const paternalLastname = document.getElementById('paternal-lastname');
            const maternalLastname = document.getElementById('maternal-lastname');
            const names = document.getElementById('names');
            const phoneNumber = document.getElementById('phone-number');
            const registrationModalTitle = document.getElementById('registration-modal-title');
            
            // Elementos del portal del alumno
            const studentName = document.getElementById('student-name');
            const studentMateriasDisplay = document.getElementById('student-materias');
            const studentMateriaSelect = document.getElementById('student-materia-select');
            const gradesList = document.getElementById('grades-list');
            const attendanceList = document.getElementById('attendance-list');
            const practicesList = document.getElementById('practices-list');
            const finalGradeValue = document.getElementById('final-grade-value');
            
            // Elementos para gestión de calificaciones
            let currentStudentKey = null;
            let currentMateriaName = null;
            let loggedInUser = null;
            let studentDataListener = null;

            const gradesMainStudentName = document.getElementById('grades-main-student-name');
            const gradesMateriaSelect = document.getElementById('grades-materia-select');
            const gradesOptions = document.getElementById('grades-options');
            
            const asistenciaStudentName = document.getElementById('asistencia-student-name');
            const practicasStudentName = document.getElementById('practicas-student-name');
            const parcialesStudentName = document.getElementById('parciales-student-name');
            
            const asistenciaPonderacionInfo = document.getElementById('asistencia-ponderacion-info');
            const practicasPonderacionInfo = document.getElementById('practicas-ponderacion-info');
            const parcialesPonderacionInfo = document.getElementById('parciales-ponderacion-info');
            
            const asistenciaInput = document.getElementById('asistencia-input');
            const practicaInputs = document.querySelectorAll('#practicas-modal input');
            const parcialInputs = document.querySelectorAll('#parciales-modal input');
            
            const asistenciaMessage = document.getElementById('asistencia-message');
            const practicasMessage = document.getElementById('practicas-message');
            const parcialesMessage = document.getElementById('parciales-message');
            
            const saveAsistenciaBtn = document.getElementById('save-asistencia-btn');
            const savePracticasBtn = document.getElementById('save-practicas-btn');
            const saveParcialesBtn = document.getElementById('save-parciales-btn');
            
            let currentTabIndex = 0;
            let editingKey = null;
            
            // Convertir a minúsculas para una comparación sin distinción de mayúsculas y minúsculas
            const adminUser = "douglas";
            const adminPass = "d5720";
            
            // Funciones para manejar los modals de confirmación y alerta
            function showMessageModal(message) {
                document.getElementById('message-text').textContent = message;
                messageModal.style.display = 'flex';
                document.getElementById('message-ok-btn').onclick = () => {
                    messageModal.style.display = 'none';
                };
            }
            
            function showConfirmationModal(message, onConfirm) {
                document.getElementById('confirmation-message').textContent = message;
                confirmationModal.style.display = 'flex';
                document.getElementById('confirm-yes-btn').onclick = () => {
                    confirmationModal.style.display = 'none';
                    onConfirm(true);
                };
                document.getElementById('confirm-no-btn').onclick = () => {
                    confirmationModal.style.display = 'none';
                    onConfirm(false);
                };
            }
            
            function showTab(index) {
                tabsContainer.style.transform = `translateX(-${index * 100 / 3}%)`;
                navItems.forEach(nav => nav.classList.remove('active'));
                navItems[index].classList.add('active');
            }
            
            function showAdminSection(panelId) {
                const sections = document.querySelectorAll('.list-container');
                sections.forEach(s => s.style.display = 'none');
                document.getElementById(panelId).style.display = 'block';
            }
            
            // Función para mostrar modals
            function showModal(modalElement) {
                modalElement.style.display = 'flex';
            }

            // Función para cerrar modals
            function closeModal(modalElement) {
                modalElement.style.display = 'none';
                editingKey = null; // Reiniciar la clave de edición
            }

            function renderList(listElement, data) {
                listElement.innerHTML = '';
                if (!data) return;
                
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    const li = document.createElement('li');
                    let nameToShow = item.nombre || item.materiaName || item.titulo || item;
                    
                    let actions = `
                        <div class="list-actions">
                            <button class="edit-btn" data-key="${key}" data-type="${listElement.id}"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button class="delete-btn" data-key="${key}" data-type="${listElement.id}"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    
                    if (listElement.id === 'calificaciones-alumnos-list') {
                         actions = `
                            <div class="list-actions">
                                <button class="action-btn" data-key="${key}" data-type="manage-grades">Gestionar Calificaciones</button>
                            </div>
                        `;
                        nameToShow = item.nombre;
                    } else if (listElement.id === 'student-list') {
                        nameToShow = item.nombre;
                    } else if (listElement.id === 'news-list') {
                        // Para la lista de noticias, mostramos el título
                        nameToShow = item.titulo;
                    }
                    
                    li.innerHTML = `
                        <span class="list-name">${nameToShow}</span>
                        ${actions}
                    `;
                    listElement.appendChild(li);
                });
            }
            
            function renderBibliotecaAdmin(data) {
                bibliotecaAdminTableBody.innerHTML = '';
                if (!data) return;
                
                Object.keys(data).forEach(key => {
                    const recurso = data[key];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${recurso.codigo}</td>
                        <td>${recurso.titulo}</td>
                        <td>${recurso.tipo}</td>
                        <td><a href="${recurso.link}" target="_blank">${recurso.link.substring(0, 25)}...</a></td>
                        <td>
                            <button class="edit-btn" data-key="${key}" data-type="biblioteca-management"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button class="delete-btn" data-key="${key}" data-type="biblioteca-management"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    `;
                    bibliotecaAdminTableBody.appendChild(row);
                });
            }
            
            // FUNCIÓN MODIFICADA: Ahora agrupa los recursos por tipo en la vista pública
            function renderBibliotecaPublic(data) {
                publicLibraryContainer.innerHTML = '';
                if (!data) {
                    publicLibraryContainer.innerHTML = '<p style="text-align: center;">No hay recursos en la biblioteca.</p>';
                    return;
                }

                // Agrupar los recursos por tipo
                const groupedData = Object.values(data).reduce((acc, recurso) => {
                    const tipo = recurso.tipo || 'Otro';
                    if (!acc[tipo]) {
                        acc[tipo] = [];
                    }
                    acc[tipo].push(recurso);
                    return acc;
                }, {});

                // Crear un grupo de recursos para cada tipo
                for (const tipo in groupedData) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'resource-group';
                    
                    const groupTitle = document.createElement('h3');
                    groupTitle.className = 'resource-group-title';
                    groupTitle.textContent = tipo;
                    groupDiv.appendChild(groupTitle);
                    
                    const table = document.createElement('table');
                    const tableHeader = document.createElement('thead');
                    tableHeader.innerHTML = `
                        <tr>
                            <th>Código</th>
                            <th>Título</th>
                            <th>Link</th>
                        </tr>
                    `;
                    table.appendChild(tableHeader);
                    
                    const tableBody = document.createElement('tbody');
                    groupedData[tipo].forEach(recurso => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${recurso.codigo}</td>
                            <td>${recurso.titulo}</td>
                            <td><a href="${recurso.link}" target="_blank">Ver Recurso</a></td>
                        `;
                        tableBody.appendChild(row);
                    });
                    table.appendChild(tableBody);
                    groupDiv.appendChild(table);
                    publicLibraryContainer.appendChild(groupDiv);
                }
            }
            
            async function renderNews() {
                dbNoticias.limitToLast(1).on('value', (snapshot) => {
                    const noticias = snapshot.val();
                    if (noticias) {
                        const lastNewsKey = Object.keys(noticias)[0];
                        const lastNews = noticias[lastNewsKey];
                        newsContainer.innerHTML = `<h3 style="text-align: center; margin-top: 20px;">${lastNews.titulo}</h3><p style="text-align: justify; margin-top: 10px;">${lastNews.cuerpo}</p>`;
                    } else {
                        newsContainer.innerHTML = `<p style="text-align: center; margin-top: 20px;">No hay noticias disponibles en este momento.</p>`;
                    }
                });
            }
            
            async function populateMateriaDropdowns() {
                materiasDropdown.innerHTML = '';
                const snapshot = await dbMaterias.once('value');
                const materias = snapshot.val();
                if (materias) {
                    Object.values(materias).forEach(materia => {
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" value="${materia.nombre}"> ${materia.nombre}`;
                        materiasDropdown.appendChild(label);
                    });
                }
            }

            // Función para calcular la nota final
            function calculateFinalGrade(grades, ponderaciones) {
                const asist = parseFloat(grades.asistencia) || 0;
                const parciales = [
                    parseFloat(grades.calificaciones?.parcial1) || 0,
                    parseFloat(grades.calificaciones?.parcial2) || 0
                ];
                const practicas = [];
                for(let i = 1; i <= 6; i++) {
                    practicas.push(parseFloat(grades.calificaciones?.[`practica${i}`]) || 0);
                }

                const promedioPracticas = practicas.reduce((sum, val) => sum + val, 0) / (practicas.length > 0 ? practicas.length : 1);
                const promedioParciales = parciales.reduce((sum, val) => sum + val, 0) / (parciales.length > 0 ? parciales.length : 1);

                const finalGrade = 
                    (asist * (ponderaciones.asistencia / 100)) + 
                    (promedioPracticas * (ponderaciones.practicas / 100)) + 
                    (promedioParciales * (ponderaciones.parciales / 100));
                
                return finalGrade.toFixed(2);
            }
            
            async function renderStudentPortal(studentData, materiaName) {
                // Obtener las ponderaciones de la materia seleccionada
                const materiaSnapshot = await dbMaterias.orderByChild('nombre').equalTo(materiaName).once('value');
                const materiaData = materiaSnapshot.val();
                
                if (!materiaData) {
                    showMessageModal(`Error: No se encontró la materia "${materiaName}" en la base de datos.`);
                    // Limpiar la interfaz
                    gradesList.innerHTML = '<p style="text-align: center;">Materia no encontrada.</p>';
                    attendanceList.innerHTML = '<p style="text-align: center;">Materia no encontrada.</p>';
                    practicesList.innerHTML = '<p style="text-align: center;">Materia no encontrada.</p>';
                    finalGradeValue.textContent = 'N/A';
                    return;
                }
                
                const materiaKey = Object.keys(materiaData)[0];
                const ponderaciones = materiaData[materiaKey].ponderaciones;
                const courseGrades = studentData.materias[materiaName] || {};
                
                // Calcular y mostrar la nota final con las ponderaciones correctas
                const finalGrade = calculateFinalGrade(courseGrades, ponderaciones);
                finalGradeValue.textContent = finalGrade;

                // Mostrar calificación de Parciales
                const promedioParciales = (
                    (parseFloat(courseGrades.calificaciones?.parcial1 || 0) + parseFloat(courseGrades.calificaciones?.parcial2 || 0)) / 2
                ).toFixed(2);
                let parcialesHTML = `
                    <p>Promedio: <span class="grade-value">${promedioParciales}</span> (Ponderación: ${ponderaciones.parciales}%)</p>
                    <div class="grade-item"><span>Parcial 1:</span><span class="grade-value">${courseGrades.calificaciones?.parcial1 || 'N/A'}</span></div>
                    <div class="grade-item"><span>Parcial 2:</span><span class="grade-value">${courseGrades.calificaciones?.parcial2 || 'N/A'}</span></div>
                `;
                gradesList.innerHTML = parcialesHTML;

                // Mostrar asistencia
                attendanceList.innerHTML = `
                    <p>Ponderación: ${ponderaciones.asistencia}% de la nota final</p>
                    <div class="grade-item"><span>Porcentaje total:</span><span class="grade-value">${courseGrades.asistencia || 'N/A'}%</span></div>
                `;

                // Mostrar calificaciones de prácticas
                const practicas = [];
                for(let i = 1; i <= 6; i++) {
                    practicas.push(parseFloat(courseGrades.calificaciones?.[`practica${i}`]) || 0);
                }
                const promedioPracticas = (practicas.reduce((sum, val) => sum + val, 0) / (practicas.length > 0 ? practicas.length : 1)).toFixed(2);
                
                let practicasHTML = `
                    <p>Promedio: <span class="grade-value">${promedioPracticas}</span> (Ponderación: ${ponderaciones.practicas}%)</p>
                `;
                for (let i = 1; i <= 6; i++) {
                    practicasHTML += `<div class="grade-item"><span>Práctica ${i}:</span><span class="grade-value">${courseGrades.calificaciones?.[`practica${i}`] || 'N/A'}</span></div>`;
                }
                practicesList.innerHTML = practicasHTML;
            }

            function populateStudentMateriaSelect(materias) {
                studentMateriaSelect.innerHTML = '';
                if (materias) {
                    const materiaNames = Object.keys(materias);
                    materiaNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        studentMateriaSelect.appendChild(option);
                    });
                    if (materiaNames.length > 0) {
                        // Cargar la primera materia por defecto
                        const defaultMateria = materiaNames[0];
                        studentMateriaSelect.value = defaultMateria;
                        renderStudentPortal(loggedInUser, defaultMateria);
                    }
                }
            }
            
            function logout() {
                loggedInUser = null;
                currentStudentKey = null;
                currentMateriaName = null;
                loginFormContainer.style.display = 'block';
                adminPanel.style.display = 'none';
                studentPortal.style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                // Detener el listener de Firebase para evitar fugas de memoria
                if (studentDataListener) {
                    dbAlumnos.child(studentDataListener.key).off('value', studentDataListener.callback);
                    studentDataListener = null;
                }
            }
            
            showTab(0);
            
            // Función para cargar todos los datos de las pestañas
            function loadData() {
                dbMaterias.on('value', (snapshot) => {
                    const materias = snapshot.val();
                    renderList(materiaList, materias);
                    populateMateriaDropdowns();
                });

                dbNoticias.on('value', (snapshot) => {
                    const noticias = snapshot.val();
                    renderList(newsList, noticias);
                });
                renderNews();

                dbAlumnos.on('value', (snapshot) => {
                    const alumnos = snapshot.val();
                    renderList(studentList, alumnos);
                    renderList(calificacionesAlumnosList, alumnos);
                });

                dbBiblioteca.on('value', (snapshot) => {
                    const recursos = snapshot.val();
                    renderBibliotecaAdmin(recursos);
                    renderBibliotecaPublic(recursos); // LLAMADA A LA FUNCIÓN ACTUALIZADA
                });
            }
            loadData();
            
            navItems.forEach((item, index) => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentTabIndex = index;
                    showTab(currentTabIndex);
                });
            });
            
            // Lógica de login y logout
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    // Convertir a minúsculas para una comparación sin distinción de mayúsculas y minúsculas
                    const username = document.getElementById('username').value.trim().toLowerCase();
                    const password = document.getElementById('password').value.trim().toLowerCase();
                    
                    if (username === adminUser && password === adminPass) {
                        loginFormContainer.style.display = 'none';
                        adminPanel.style.display = 'block';
                        errorMessage.style.display = 'none';
                    } else {
                        // Lógica de login para alumnos
                        const snapshot = await dbAlumnos.orderByChild('usuario').equalTo(username).once('value');
                        const alumno = snapshot.val();

                        if (alumno) {
                            const alumnoKey = Object.keys(alumno)[0];
                            const alumnoData = alumno[alumnoKey];
                            if (alumnoData.contrasena.toLowerCase() === password) {
                                loggedInUser = alumnoData;
                                loginFormContainer.style.display = 'none';
                                adminPanel.style.display = 'none';
                                studentPortal.style.display = 'block';
                                errorMessage.style.display = 'none';
                                
                                studentName.textContent = loggedInUser.nombre;
                                studentMateriasDisplay.textContent = Object.keys(loggedInUser.materias || {}).join(', ');
                                
                                // Poblar el selector de materias y renderizar el portal
                                populateStudentMateriaSelect(loggedInUser.materias);
                                
                                // Escuchar cambios en los datos del alumno en tiempo real
                                const onStudentDataChange = (snapshot) => {
                                    const updatedStudentData = snapshot.val();
                                    loggedInUser = updatedStudentData;
                                    studentMateriasDisplay.textContent = Object.keys(loggedInUser.materias || {}).join(', ');
                                    populateStudentMateriaSelect(loggedInUser.materias);
                                    if (studentMateriaSelect.value) {
                                        renderStudentPortal(loggedInUser, studentMateriaSelect.value);
                                    }
                                };
                                dbAlumnos.child(alumnoKey).on('value', onStudentDataChange);
                                studentDataListener = { key: alumnoKey, callback: onStudentDataChange };

                            } else {
                                errorMessage.style.display = 'block';
                            }
                        } else {
                            errorMessage.style.display = 'block';
                        }
                    }
                });
            }
            logoutBtn.addEventListener('click', logout);
            studentLogoutBtn.addEventListener('click', logout);

            // Listener para el cambio de materia en el portal del alumno
            studentMateriaSelect.addEventListener('change', (e) => {
                const selectedMateria = e.target.value;
                if (loggedInUser && selectedMateria) {
                    renderStudentPortal(loggedInUser, selectedMateria);
                }
            });

            // Lógica para abrir modals desde el panel de administrador
            adminPanelButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const modalId = e.target.dataset.modal;
                    const modalElement = document.getElementById(modalId);
                    if (modalElement) {
                        showModal(modalElement);
                    }
                });
            });

            // Lógica para el nuevo panel de gestión de calificaciones
            calificacionesAlumnosList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target || target.dataset.type !== 'manage-grades') return;
                
                const key = target.dataset.key;
                currentStudentKey = key;
                const snapshot = await dbAlumnos.child(key).once('value');
                const alumno = snapshot.val();
                
                if (alumno) {
                    gradesMainStudentName.textContent = alumno.nombre;
                    
                    // Llenar el selector de materias en el modal principal
                    gradesMateriaSelect.innerHTML = '<option value="">Seleccione una materia</option>';
                    if (alumno.materias) {
                        Object.keys(alumno.materias).forEach(materiaName => {
                            const option = document.createElement('option');
                            option.value = materiaName;
                            option.textContent = materiaName;
                            gradesMateriaSelect.appendChild(option);
                        });
                    }
                    
                    gradesOptions.style.display = 'none';
                    showModal(gradesMainModal);
                } else {
                    showMessageModal('No se encontró al alumno.');
                }
            });
            
            // Listener para el selector de materia en el modal de gestión de calificaciones
            gradesMateriaSelect.addEventListener('change', (e) => {
                currentMateriaName = e.target.value;
                if (currentMateriaName) {
                    gradesOptions.style.display = 'flex';
                } else {
                    gradesOptions.style.display = 'none';
                }
            });

            // Lógica para abrir los modales individuales de gestión de notas
            document.getElementById('open-asistencia-btn').addEventListener('click', async () => {
                if (!currentStudentKey || !currentMateriaName) return;
                closeModal(gradesMainModal);
                const snapshot = await dbAlumnos.child(currentStudentKey).once('value');
                const alumno = snapshot.val();
                const courseGrades = alumno?.materias?.[currentMateriaName] || {};
                
                const materiaSnapshot = await dbMaterias.orderByChild('nombre').equalTo(currentMateriaName).once('value');
                const materiaData = materiaSnapshot.val();
                const materiaKey = Object.keys(materiaData)[0];
                const ponderaciones = materiaData[materiaKey].ponderaciones;
                
                asistenciaStudentName.textContent = `${alumno.nombre} - ${currentMateriaName}`;
                asistenciaPonderacionInfo.innerHTML = `Ponderación: <strong>${ponderaciones.asistencia}%</strong> de la nota final`;
                asistenciaInput.value = courseGrades.asistencia || '0';
                asistenciaMessage.style.display = 'none';

                showModal(asistenciaModal);
            });

            document.getElementById('open-practicas-btn').addEventListener('click', async () => {
                if (!currentStudentKey || !currentMateriaName) return;
                closeModal(gradesMainModal);
                const snapshot = await dbAlumnos.child(currentStudentKey).once('value');
                const alumno = snapshot.val();
                const courseGrades = alumno?.materias?.[currentMateriaName] || {};

                const materiaSnapshot = await dbMaterias.orderByChild('nombre').equalTo(currentMateriaName).once('value');
                const materiaData = materiaSnapshot.val();
                const materiaKey = Object.keys(materiaData)[0];
                const ponderaciones = materiaData[materiaKey].ponderaciones;

                practicasStudentName.textContent = `${alumno.nombre} - ${currentMateriaName}`;
                practicasPonderacionInfo.innerHTML = `Ponderación: <strong>${ponderaciones.practicas}%</strong> de la nota final`;

                practicaInputs.forEach((input, index) => {
                    input.value = courseGrades.calificaciones?.[`practica${index + 1}`] || '0';
                });
                practicasMessage.style.display = 'none';
                
                showModal(practicasModal);
            });

            document.getElementById('open-parciales-btn').addEventListener('click', async () => {
                if (!currentStudentKey || !currentMateriaName) return;
                closeModal(gradesMainModal);
                const snapshot = await dbAlumnos.child(currentStudentKey).once('value');
                const alumno = snapshot.val();
                const courseGrades = alumno?.materias?.[currentMateriaName] || {};
                
                const materiaSnapshot = await dbMaterias.orderByChild('nombre').equalTo(currentMateriaName).once('value');
                const materiaData = materiaSnapshot.val();
                const materiaKey = Object.keys(materiaData)[0];
                const ponderaciones = materiaData[materiaKey].ponderaciones;
                
                parcialesStudentName.textContent = `${alumno.nombre} - ${currentMateriaName}`;
                parcialesPonderacionInfo.innerHTML = `Ponderación: <strong>${ponderaciones.parciales}%</strong> de la nota final`;

                parcialInputs.forEach((input, index) => {
                    input.value = courseGrades.calificaciones?.[`parcial${index + 1}`] || '0';
                });
                parcialesMessage.style.display = 'none';
                
                showModal(parcialesModal);
            });
            
            // Lógica para guardar calificaciones
            saveAsistenciaBtn.addEventListener('click', async () => {
                if (!currentStudentKey || !currentMateriaName) return;
                const asistenciaValue = asistenciaInput.value;
                try {
                    await dbAlumnos.child(currentStudentKey).child('materias').child(currentMateriaName).update({ asistencia: asistenciaValue });
                    asistenciaMessage.textContent = 'Asistencia guardada correctamente.';
                    asistenciaMessage.className = 'success';
                    asistenciaMessage.style.display = 'block';
                    setTimeout(() => asistenciaMessage.style.display = 'none', 3000);
                } catch (error) {
                    console.error("Error al guardar asistencia:", error);
                    asistenciaMessage.textContent = 'Error al guardar la asistencia.';
                    asistenciaMessage.className = 'error';
                    asistenciaMessage.style.display = 'block';
                    setTimeout(() => asistenciaMessage.style.display = 'none', 3000);
                }
            });

            savePracticasBtn.addEventListener('click', async () => {
                if (!currentStudentKey || !currentMateriaName) return;
                const updates = {};
                practicaInputs.forEach((input, index) => {
                    updates[`calificaciones/practica${index + 1}`] = input.value || '0';
                });
                
                try {
                    await dbAlumnos.child(currentStudentKey).child('materias').child(currentMateriaName).update(updates);
                    practicasMessage.textContent = 'Prácticas guardadas correctamente.';
                    practicasMessage.className = 'success';
                    practicasMessage.style.display = 'block';
                    setTimeout(() => practicasMessage.style.display = 'none', 3000);
                } catch (error) {
                    console.error("Error al guardar prácticas:", error);
                    practicasMessage.textContent = 'Error al guardar las prácticas.';
                    practicasMessage.className = 'error';
                    practicasMessage.style.display = 'block';
                    setTimeout(() => practicasMessage.style.display = 'none', 3000);
                }
            });

            saveParcialesBtn.addEventListener('click', async () => {
                if (!currentStudentKey || !currentMateriaName) return;
                const updates = {
                    'calificaciones/parcial1': document.getElementById('parcial1-input').value || '0',
                    'calificaciones/parcial2': document.getElementById('parcial2-input').value || '0',
                };
                
                try {
                    await dbAlumnos.child(currentStudentKey).child('materias').child(currentMateriaName).update(updates);
                    parcialesMessage.textContent = 'Parciales guardados correctamente.';
                    parcialesMessage.className = 'success';
                    parcialesMessage.style.display = 'block';
                    setTimeout(() => parcialesMessage.style.display = 'none', 3000);
                } catch (error) {
                    console.error("Error al guardar parciales:", error);
                    parcialesMessage.textContent = 'Error al guardar los parciales.';
                    parcialesMessage.className = 'error';
                    parcialesMessage.style.display = 'block';
                    setTimeout(() => parcialesMessage.style.display = 'none', 3000);
                }
            });
            
            // Botones para abrir modals de creación
            createMateriaBtnInPanel.addEventListener('click', (e) => {
                e.preventDefault();
                editingKey = null;
                document.querySelector('#materia-modal h2').innerHTML = '<i class="fa-solid fa-pen-to-square"></i>Crear Materia';
                materiaForm.reset();
                showModal(materiaModal);
            });
            createNewsBtnInPanel.addEventListener('click', (e) => {
                e.preventDefault();
                editingKey = null;
                document.querySelector('#news-modal h2').innerHTML = '<i class="fa-solid fa-newspaper"></i>Crear Noticia/Evento';
                newsForm.reset();
                showModal(newsModal);
            });
            createStudentBtnInPanel.addEventListener('click', async (e) => {
                e.preventDefault();
                editingKey = null;
                await populateMateriaDropdowns();
                document.getElementById('materias-display-label').textContent = 'Seleccione materias';
                registrationModalTitle.innerHTML = '<i class="fa-solid fa-user-plus"></i>Registrar Alumno';
                registrationForm.reset();
                showModal(registrationModal);
            });
            createLibraryResourceBtnInPanel.addEventListener('click', (e) => {
                e.preventDefault();
                editingKey = null;
                document.querySelector('#biblioteca-modal h2').innerHTML = '<i class="fa-solid fa-folder-plus"></i>Crear Recurso';
                bibliotecaForm.reset();
                showModal(bibliotecaModal);
            });

            // Lógica para el multi-select de materias
            document.querySelector('.multi-select-container').addEventListener('click', (e) => {
                const dropdownContent = e.currentTarget.querySelector('.dropdown-content');
                if (e.target.closest('.selected-items-display')) {
                    dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
                }
            });
            materiasDropdown.addEventListener('change', (e) => {
                const selectedItemsDisplay = document.querySelector('.selected-items-display');
                const checkboxes = materiasDropdown.querySelectorAll('input[type="checkbox"]');
                const selectedMaterias = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

                selectedItemsDisplay.innerHTML = '';
                if (selectedMaterias.length > 0) {
                    selectedMaterias.forEach(materia => {
                        const tag = document.createElement('span');
                        tag.className = 'selected-item-tag';
                        tag.textContent = materia;
                        selectedItemsDisplay.appendChild(tag);
                    });
                } else {
                    selectedItemsDisplay.innerHTML = '<span id="materias-display-label">Seleccione materias</span>';
                }
            });

            // Lógica para cerrar modals
            document.querySelectorAll('.modal .close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.target.closest('.modal'));
                });
            });
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    closeModal(event.target);
                }
            });

            // Lógica para crear, modificar y eliminar materias (con modal)
            materiaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const materiaName = materiaNameInput.value;
                const asistenciaPonderacion = asistenciaPonderacionInput.value;
                const practicasPonderacion = practicasPonderacionInput.value;
                const parcialesPonderacion = parcialesPonderacionInput.value;

                // Validación simple de ponderaciones
                if (parseInt(asistenciaPonderacion) + parseInt(practicasPonderacion) + parseInt(parcialesPonderacion) !== 100) {
                    showMessageModal('La suma de las ponderaciones debe ser 100%.');
                    return;
                }

                const data = { 
                    nombre: materiaName,
                    ponderaciones: {
                        asistencia: asistenciaPonderacion,
                        practicas: practicasPonderacion,
                        parciales: parcialesPonderacion
                    }
                };
                try {
                    if (editingKey) {
                        await dbMaterias.child(editingKey).set(data);
                        showMessageModal('Materia actualizada correctamente.');
                    } else {
                        await dbMaterias.push(data);
                        showMessageModal('Materia creada correctamente.');
                    }
                    closeModal(materiaModal);
                    materiaForm.reset();
                } catch (error) {
                    console.error("Error al guardar materia:", error);
                    showMessageModal('Error al guardar la materia. Por favor, inténtelo de nuevo.');
                }
            });
            materiaList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const key = target.dataset.key;
                if (target.classList.contains('edit-btn')) {
                    const snapshot = await dbMaterias.child(key).once('value');
                    const materia = snapshot.val();
                    if (!materia) { // FIX: Added check for data
                        showMessageModal('No se encontró la materia.');
                        return;
                    }
                    editingKey = key;
                    document.querySelector('#materia-modal h2').innerHTML = '<i class="fa-solid fa-pen-to-square"></i>Modificar Materia';
                    materiaNameInput.value = materia.nombre;
                    asistenciaPonderacionInput.value = materia.ponderaciones.asistencia;
                    practicasPonderacionInput.value = materia.ponderaciones.practicas;
                    parcialesPonderacionInput.value = materia.ponderaciones.parciales;
                    showModal(materiaModal);
                } else if (target.classList.contains('delete-btn')) {
                    showConfirmationModal('¿Estás seguro de que quieres eliminar esta materia?', async (confirmed) => {
                        if (confirmed) {
                            try {
                                await dbMaterias.child(key).remove();
                                showMessageModal('Materia eliminada correctamente.');
                            } catch (error) {
                                console.error("Error al eliminar materia:", error);
                                showMessageModal('Error al eliminar la materia. Por favor, inténtelo de nuevo.');
                            }
                        }
                    });
                }
            });

            // Lógica para crear, modificar y eliminar noticias (con modal)
            newsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newsTitle = newsTitleInput.value;
                const newsBody = newsBodyInput.value;
                const data = { titulo: newsTitle, cuerpo: newsBody };
                try {
                    if (editingKey) {
                        await dbNoticias.child(editingKey).set(data);
                        showMessageModal('Noticia actualizada correctamente.');
                    } else {
                        await dbNoticias.push(data);
                        showMessageModal('Noticia creada correctamente.');
                    }
                    closeModal(newsModal);
                    newsForm.reset();
                } catch (error) {
                    console.error("Error al guardar noticia:", error);
                    showMessageModal('Error al guardar la noticia. Por favor, inténtelo de nuevo.');
                }
            });
            newsList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const key = target.dataset.key;
                if (target.classList.contains('edit-btn')) {
                    const snapshot = await dbNoticias.child(key).once('value');
                    const noticia = snapshot.val();
                    if (!noticia) { // FIX: Added check for data
                        showMessageModal('No se encontró la noticia.');
                        return;
                    }
                    editingKey = key;
                    document.querySelector('#news-modal h2').innerHTML = '<i class="fa-solid fa-newspaper"></i>Modificar Noticia/Evento';
                    newsTitleInput.value = noticia.titulo;
                    newsBodyInput.value = noticia.cuerpo;
                    showModal(newsModal);
                } else if (target.classList.contains('delete-btn')) {
                    showConfirmationModal('¿Estás seguro de que quieres eliminar esta noticia?', async (confirmed) => {
                        if (confirmed) {
                            try {
                                await dbNoticias.child(key).remove();
                                showMessageModal('Noticia eliminada correctamente.');
                            } catch (error) {
                                console.error("Error al eliminar noticia:", error);
                                showMessageModal('Error al eliminar la noticia. Por favor, inténtelo de nuevo.');
                            }
                        }
                    });
                }
            });

            // Lógica para el modal de registro y gestión de alumnos
            registrationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const studentNames = names.value.trim();
                const studentPaternal = paternalLastname.value.trim();
                const studentMaternal = maternalLastname.value.trim();
                const studentPhone = phoneNumber.value.trim();
                
                const selectedMaterias = Array.from(materiasDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

                if (selectedMaterias.length === 0) {
                    showMessageModal('Debe seleccionar al menos una materia.');
                    return;
                }
                
                const initialCourseData = {
                    calificaciones: {
                        parcial1: '0',
                        parcial2: '0',
                        practica1: '0',
                        practica2: '0',
                        practica3: '0',
                        practica4: '0',
                        practica5: '0',
                        practica6: '0',
                    },
                    asistencia: '0',
                };
                
                const materiasObject = {};
                selectedMaterias.forEach(materia => {
                    materiasObject[materia] = { ...initialCourseData };
                });

                const studentData = {
                    paternal: studentPaternal,
                    maternal: studentMaternal,
                    names: studentNames,
                    phone: studentPhone,
                    nombre: `${studentNames} ${studentPaternal} ${studentMaternal}`,
                    // Usuario y contraseña en minúsculas por defecto
                    usuario: studentNames.toLowerCase().replace(/\s/g, ''),
                    contrasena: studentPhone.toLowerCase(), 
                    rol: 'alumno',
                    materias: materiasObject
                };
                
                try {
                    if (editingKey) {
                        // Al editar, actualizamos solo los campos que cambiaron
                        const existingStudent = (await dbAlumnos.child(editingKey).once('value')).val();
                        const updatedMaterias = { ...existingStudent.materias, ...materiasObject };
                        
                        await dbAlumnos.child(editingKey).update({ ...studentData, materias: updatedMaterias });
                        showMessageModal('Alumno actualizado correctamente.');
                    } else {
                        await dbAlumnos.push(studentData);
                        showMessageModal('Alumno registrado correctamente.');
                    }
                    closeModal(registrationModal);
                    registrationForm.reset();
                } catch (error) {
                    console.error("Error al guardar alumno:", error);
                    showMessageModal('Error al guardar el alumno. Por favor, inténtelo de nuevo.');
                }
            });
            studentList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const key = target.dataset.key;
                if (target.classList.contains('edit-btn')) {
                    const snapshot = await dbAlumnos.child(key).once('value');
                    const alumno = snapshot.val();
                    if (!alumno) { // FIX: Added check for data
                        showMessageModal('No se encontró al alumno.');
                        return;
                    }
                    editingKey = key;
                    await populateMateriaDropdowns();
                    
                    registrationModalTitle.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>Modificar Alumno';
                    paternalLastname.value = alumno.paternal;
                    maternalLastname.value = alumno.maternal;
                    names.value = alumno.names;
                    phoneNumber.value = alumno.phone;
                    
                    // Marcar los checkboxes de las materias ya inscritas
                    const selectedMateriasDisplay = document.querySelector('.selected-items-display');
                    selectedMateriasDisplay.innerHTML = '';
                    if (alumno.materias) {
                        const enrolledMaterias = Object.keys(alumno.materias);
                        enrolledMaterias.forEach(materiaName => {
                             const tag = document.createElement('span');
                            tag.className = 'selected-item-tag';
                            tag.textContent = materiaName;
                            selectedMateriasDisplay.appendChild(tag);
                            const checkbox = materiasDropdown.querySelector(`input[value="${materiaName}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    
                    showModal(registrationModal);
                } else if (target.classList.contains('delete-btn')) {
                    showConfirmationModal('¿Estás seguro de que quieres eliminar a este alumno?', async (confirmed) => {
                        if (confirmed) {
                            try {
                                await dbAlumnos.child(key).remove();
                                showMessageModal('Alumno eliminado correctamente.');
                            } catch (error) {
                                console.error("Error al eliminar alumno:", error);
                                showMessageModal('Error al eliminar el alumno. Por favor, inténtelo de nuevo.');
                            }
                        }
                    });
                }
            });

            // Lógica para la gestión de biblioteca (con modal)
            bibliotecaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const codigo = document.getElementById('codigo-select').value;
                const titulo = document.getElementById('recurso-titulo').value;
                const tipo = document.getElementById('tipo-select').value;
                const link = document.getElementById('recurso-link').value;
                
                const newRecurso = { codigo, titulo, tipo, link };
                
                try {
                    if (editingKey) {
                        await dbBiblioteca.child(editingKey).set(newRecurso);
                        showMessageModal('Recurso actualizado correctamente.');
                    } else {
                        await dbBiblioteca.push(newRecurso);
                        showMessageModal('Recurso creado correctamente.');
                    }
                    closeModal(bibliotecaModal);
                    bibliotecaForm.reset();
                } catch (error) {
                    console.error("Error al guardar recurso:", error);
                    showMessageModal('Error al guardar el recurso. Por favor, inténtelo de nuevo.');
                }
            });
            
            bibliotecaManagement.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const key = target.dataset.key;
                
                if (target.classList.contains('edit-btn')) {
                    const snapshot = await dbBiblioteca.child(key).once('value');
                    const recurso = snapshot.val();
                    if (!recurso) { // FIX: Added check for data
                        showMessageModal('No se encontró el recurso.');
                        return;
                    }
                    editingKey = key;
                    document.querySelector('#biblioteca-modal h2').innerHTML = '<i class="fa-solid fa-pen-to-square"></i>Modificar Recurso';
                    document.getElementById('codigo-select').value = recurso.codigo;
                    document.getElementById('recurso-titulo').value = recurso.titulo;
                    document.getElementById('tipo-select').value = recurso.tipo;
                    document.getElementById('recurso-link').value = recurso.link;
                    showModal(bibliotecaModal);
                } else if (target.classList.contains('delete-btn')) {
                    showConfirmationModal('¿Estás seguro de que quieres eliminar este recurso?', async (confirmed) => {
                        if (confirmed) {
                            try {
                                await dbBiblioteca.child(key).remove();
                                showMessageModal('Recurso eliminado correctamente.');
                            } catch (error) {
                                console.error("Error al eliminar recurso:", error);
                                showMessageModal('Error al eliminar el recurso. Por favor, inténtelo de nuevo.');
                            }
                        }
                    });
                }
            });
            
            // Lógica del icono del ojo
            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    togglePassword.querySelector('i').classList.toggle('fa-eye');
                    togglePassword.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }
        });
    </script>
</body>
</html>
